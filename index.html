<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.1 â€” Carregamento AutomÃ¡tico</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: "Inter", "Segoe UI", sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 1px 3px rgba(16,24,40,0.05);
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--accent); }
    .brand span { font-size: 11px; color: var(--muted); }

    .controls { display: flex; gap: 10px; }
    
    .btn, .file, .select {
      border: 1px solid var(--line); background: #fff;
      color: var(--text); border-radius: 6px; padding: 8px 14px;
      font-size: 12px; display: inline-flex; gap: 8px; align-items: center;
      cursor: pointer; transition: 0.2s; font-weight: 500;
    }
    .btn:hover { background: #f9fafb; border-color: #d0d5dd; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 360px; }

    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
    }

    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; overflow: hidden; }
    .dimItems { max-height: 280px; overflow-y: auto; padding: 6px; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 8px; font-size: 12px; cursor: pointer; border-radius: 4px; }

    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; }
    .node rect { stroke-width: 1.5px; rx: 4; ry: 4; }
    .node text { font-size: 12px; font-weight: 600; pointer-events: none; }
    .node--connector rect { stroke-dasharray: 4,4; fill-opacity: 0.05; }

    .tooltip {
      position: fixed; display: none; z-index: 1000;
      background: #101828; color: #fff; padding: 12px;
      border-radius: 8px; font-size: 12px; max-width: 320px;
      line-height: 1.5; box-shadow: 0 12px 16px -4px rgba(16,24,40,0.1);
    }
    .tooltip .t-name { color: #84adff; font-weight: 800; border-bottom: 1px solid #344054; padding-bottom: 5px; margin-bottom: 8px; }
    .tooltip .t-label { font-weight: 700; color: #98a2b3; text-transform: uppercase; font-size: 10px; margin-top: 8px; }

    .status-pill { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .status-online { background: #ecfdf3; color: #027a48; }
    .status-offline { background: #fef3f2; color: #b42318; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V3.1</h1>
    <span id="statusLabel">Iniciando sistema...</span>
  </div>

  <div class="controls">
    <div class="btn" id="btnFit">ðŸŽ¯ Resetar Zoom</div>
    <div class="btn primary" id="btnPng">ðŸ“¸ Exportar PNG</div>
    <label class="file btn" style="font-size: 10px; opacity: 0.6;">
      ðŸ“‚ Backup Manual <input id="fileInput" type="file" accept=".xlsx" style="display:none;"/>
    </label>
  </div>
</header>

<div id="wrap">
  <div class="canvas"><svg id="svg"></svg></div>
  <div class="side">
    <section>
        <h3>1. DimensÃµes</h3>
        <div class="dimList"><div class="dimItems" id="dimItems">Carregando dados...</div></div>
    </section>

    <section>
        <h3>2. Termo Raiz</h3>
        <select id="rootSelect" class="select" style="width:100%; margin-bottom:12px;"></select>
        <div class="btn primary" id="btnGenerate" style="width:100%; justify-content:center;">Gerar Taxonomia</div>
    </section>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
let RAW_DATA = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.02, 4]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

// UnificaÃ§Ã£o de DimensÃµes
function cleanDim(dim) {
    let d = String(dim || "Geral").trim();
    if (d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes("motivacao e consequencia")) {
        return "MotivaÃ§Ã£o e consequÃªncia";
    }
    return d;
}

// LÃ³gica de Cores e Contraste
const getContrast = hex => {
    const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
    return ((r*299)+(g*587)+(b*114))/1000 >= 150 ? '#101828' : '#ffffff';
};
const stringToColor = str => `hsl(${[...str].reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0) % 360}, 65%, 40%)`;

// --- FUNÃ‡ÃƒO DE CARREGAMENTO AUTOMÃTICO ---
async function autoLoadExcel() {
    const fileName = "Ontohate_V2.xlsx"; 
    try {
        const response = await fetch(fileName);
        if (!response.ok) throw new Error("Arquivo nÃ£o encontrado automaticamente.");
        const arrayBuffer = await response.arrayBuffer();
        processExcel(arrayBuffer);
        document.getElementById('statusLabel').innerHTML = `<span class="status-pill status-online">Arquivo: ${fileName}</span>`;
    } catch (err) {
        console.warn(err.message);
        document.getElementById('statusLabel').innerHTML = `<span class="status-pill status-offline">Aguardando arquivo manual...</span>`;
        document.getElementById('dimItems').innerText = "Por favor, use o botÃ£o 'Backup Manual' para carregar a Ontohate_V2.xlsx.";
    }
}

function processExcel(buffer) {
    const workbook = XLSX.read(buffer);
    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
    const nodes = new Map(), childrenMap = new Map(), dims = new Set();

    json.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = cleanDim(row.DimensÃ£o || row.Subontologia || "Geral");

        if(!name) return;
        nodes.set(name, { name, dim, comment: row.Comment || row.Comments || row.ObservaÃ§Ã£o || "", obs: row.ObservaÃ§Ãµes || "" });
        dims.add(dim);
        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });

    RAW_DATA = { nodes, childrenMap, dims: Array.from(dims).sort() };
    renderUI();
}

function renderUI() {
    const container = document.getElementById('dimItems');
    container.innerHTML = RAW_DATA.dims.map(d => `
        <label class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:10px; height:10px; border-radius:50%; background:${stringToColor(d)}"></span>
            ${d}
        </label>
    `).join('');

    const select = document.getElementById('rootSelect');
    select.innerHTML = '<option value="">Escolha a raiz...</option>';
    RAW_DATA.nodes.forEach((v, k) => {
        if((RAW_DATA.childrenMap.get(k) || []).length > 0) {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = k;
            select.appendChild(opt);
        }
    });
}

// ConstruÃ§Ã£o da Ãrvore
function buildTree(nodeName, selectedDims, visited = new Set()) {
    if (visited.has(nodeName)) return null;
    visited.add(nodeName);
    const nodeData = RAW_DATA.nodes.get(nodeName) || { name: nodeName, dim: "Geral" };
    const children = (RAW_DATA.childrenMap.get(nodeName) || [])
        .map(c => buildTree(c, selectedDims, visited))
        .filter(c => c !== null);

    const isTarget = selectedDims.has(nodeData.dim);
    if (isTarget || children.length > 0) {
        return { ...nodeData, isConnector: !isTarget, children: children.length > 0 ? children : null };
    }
    return null;
}

function render() {
    const rootName = document.getElementById('rootSelect').value;
    const selectedDims = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    if(!rootName) return alert("Selecione a raiz.");

    const treeData = buildTree(rootName, selectedDims);
    if(!treeData) return alert("Nenhum dado com estas dimensÃµes.");

    gMain.selectAll("*").remove();
    const root = d3.hierarchy(treeData);
    const treeLayout = d3.tree().nodeSize([250, 150]);
    treeLayout(root);

    const links = root.links();
    const nodes = root.descendants();

    gMain.selectAll(".link").data(links).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    const node = gMain.selectAll(".node").data(nodes).enter().append("g")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseover", showTooltip).on("mouseout", () => d3.select("#tooltip").style("display", "none"));

    node.each(function(d) {
        const group = d3.select(this);
        const text = group.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
        const bbox = text.node().getBBox();
        const rectW = Math.max(160, bbox.width + 30), rectH = 40;
        const bgColor = d.data.isConnector ? "#ffffff" : stringToColor(d.data.dim);
        
        group.insert("rect", "text").attr("width", rectW).attr("height", rectH).attr("x", -rectW/2).attr("y", -rectH/2)
            .attr("fill", bgColor).attr("stroke", d.data.isConnector ? "#98a2b3" : d3.color(bgColor).darker());
        text.style("fill", getContrast(d3.rgb(bgColor).formatHex()));
    });

    autoFit();
}

function autoFit() {
    const bounds = gMain.node().getBBox();
    const scale = Math.min(0.9, 0.9 / Math.max(bounds.width / svg.node().clientWidth, bounds.height / svg.node().clientHeight));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(svg.node().clientWidth/2 - (bounds.x + bounds.width/2)*scale, 60).scale(scale));
}

function showTooltip(e, d) {
    d3.select("#tooltip").style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
      .html(`<div class="t-name">${d.data.name}</div><div class="t-label">ComentÃ¡rio</div><div>${d.data.comment || '-'}</div>${d.data.obs ? `<div class="t-label">ObservaÃ§Ãµes</div><div>${d.data.obs}</div>` : ''}`);
}

// Eventos
document.getElementById('btnGenerate').onclick = render;
document.getElementById('btnFit').onclick = autoFit;
document.getElementById('fileInput').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => processExcel(ev.target.result);
    reader.readAsArrayBuffer(e.target.files[0]);
};
document.getElementById('btnPng').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svgEl);
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
    img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = 3;
        canvas.width = svgEl.clientWidth * scale; canvas.height = svgEl.clientHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.scale(scale, scale); ctx.drawImage(img, 0, 0);
        const link = document.createElement("a");
        link.download = `taxonomia_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
    };
};

// InÃ­cio automÃ¡tico
autoLoadExcel();
</script>
</body>
</html>
