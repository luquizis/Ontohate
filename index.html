<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.6 ‚Äî Interface For√ßada</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc; --highlight: #f97316;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--text); }
    
    #statusBadge { font-size: 10px; padding: 4px 12px; border-radius: 20px; font-weight: 700; background: #f2f4f7; color: #667085; }
    .status-ok { background: #ecfdf3 !important; color: #027a48 !important; }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 400px; }
    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
    }

    /* Bot√£o de Upload Fixo e Vis√≠vel */
    .upload-box {
      border: 2px dashed var(--line); padding: 20px; text-align: center;
      border-radius: 12px; background: #fff; cursor: pointer; transition: 0.2s;
    }
    .upload-box:hover { border-color: var(--accent); background: #f0f7ff; }
    .upload-box b { display: block; color: var(--accent); margin-bottom: 5px; }

    .btn {
      border: 1px solid var(--line); background: #fff; color: var(--text); 
      border-radius: 8px; padding: 10px 16px; font-size: 12px; 
      cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn.primary { background: #101828; color: #fff; border-color: #101828; }

    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; min-height: 100px; max-height: 200px; overflow-y: auto; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 8px; font-size: 12px; border-bottom: 1px solid #f2f4f7; }

    .node rect { stroke-width: 1.5px; rx: 6; ry: 6; }
    .node text { font-size: 11px; font-weight: 700; pointer-events: none; }
    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; opacity: 0.5; }
    
    .node--is-root rect { stroke: var(--highlight) !important; stroke-width: 4px !important; }
    .node--connector rect { stroke-dasharray: 5,3; fill: #f9fafb !important; stroke: #d0d5dd !important; }

    .tooltip {
      position: fixed; display: none; z-index: 1000; background: #101828; color: #fff; 
      padding: 15px; border-radius: 8px; font-size: 12px; max-width: 320px; line-height: 1.5;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V3.6</h1>
    <span id="statusBadge">Aguardando Base Ontohate_V2.xlsx</span>
  </div>
  <div class="controls">
    <button class="btn" onclick="location.reload()">üîÑ Resetar Sistema</button>
    <button class="btn primary" id="btnExport">üì∏ Exportar Figura</button>
  </div>
</header>

<div id="wrap">
  <div class="canvas"><svg id="svg"></svg></div>
  <div class="side">
    
    <div class="upload-box" onclick="document.getElementById('manualInput').click()">
        <b>Clique aqui para subir o arquivo</b>
        <span>Ontohate_V2.xlsx</span>
    </div>

    <section>
        <h3 style="font-size:12px; margin:0 0 10px 0;">1. SELECIONAR DIMENS√ïES</h3>
        <div class="dimList" id="dimContainer"><div style="padding:20px; color:#98a2b3; font-size:11px; text-align:center;">As dimens√µes aparecer√£o aqui ap√≥s o upload</div></div>
        <div style="display:flex; gap:5px; margin-top:8px;">
            <button class="btn" onclick="toggleDims(true)" style="padding:5px 10px">Todas</button>
            <button class="btn" onclick="toggleDims(false)" style="padding:5px 10px">Nenhuma</button>
        </div>
    </section>

    <section>
        <h3 style="font-size:12px; margin:0 0 10px 0;">2. TERMO RAIZ</h3>
        <select id="rootSelect" class="btn" style="width:100%; margin-bottom:12px; text-align:left;">
            <option>Aguardando arquivo...</option>
        </select>
        <button class="btn primary" id="btnGenerate" style="width:100%;">GERAR VISUALIZA√á√ÉO</button>
    </section>

    <div style="font-size: 10px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 15px;">
        <b>Dicas de Navega√ß√£o:</b><br>
        ‚Ä¢ Passe o mouse para ver detalhes cient√≠ficos.<br>
        ‚Ä¢ Use a roda do mouse para Zoom.<br>
        ‚Ä¢ Clique e arraste o fundo branco para mover a √°rvore.
    </div>
  </div>
</div>

<input type="file" id="manualInput" style="display:none" accept=".xlsx">
<div class="tooltip" id="tooltip"></div>

<script>
let RAW = null;
const svg = d3.select("#svg"), gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.01, 3]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

const fileInput = document.getElementById('manualInput');

// Fun√ß√£o de Processamento Manual
fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        processRows(rows);
    };
    reader.readAsArrayBuffer(file);
};

function processRows(rows) {
    const nodes = new Map(), childrenMap = new Map(), dims = new Set();

    rows.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = String(row.Dimens√£o || row.Subontologia || "Geral").trim();

        if(!name) return;
        nodes.set(name, { 
            name, dim, 
            comment: row.Comment || row.Comments || row.Observa√ß√£o || "Sem defini√ß√£o.",
            obs: row.Observa√ß√µes || ""
        });
        dims.add(dim);
        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });

    RAW = { nodes, childrenMap, dims: Array.from(dims).sort() };
    
    // Atualiza Interface
    document.getElementById('statusBadge').textContent = "Base Integrada";
    document.getElementById('statusBadge').className = "status-ok";
    document.querySelector('.upload-box').style.display = 'none';
    
    fillUI();
}

function fillUI() {
    const dimBox = document.getElementById('dimContainer');
    dimBox.innerHTML = RAW.dims.map(d => `
        <div class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:8px; height:8px; border-radius:50%; background:${getCol(d)}"></span>
            ${d}
        </div>
    `).join('');
    
    const select = document.getElementById('rootSelect');
    select.innerHTML = Array.from(RAW.nodes.keys()).sort().map(k => `<option value="${k}">${k}</option>`).join('');
}

function getCol(s) {
    let h = 0; for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
    return `hsl(${Math.abs(h)%360}, 65%, 45%)`;
}

function toggleDims(s) { document.querySelectorAll('.dim-check').forEach(i => i.checked = s); }

// L√≥gica de Gera√ß√£o
function build(node, targets, rootId, visited = new Set()) {
    if (visited.has(node)) return null; visited.add(node);
    const data = RAW.nodes.get(node) || { name: node, dim: "Conector" };
    const kids = (RAW.childrenMap.get(node) || []).map(c => build(c, targets, rootId, visited)).filter(c => c !== null);
    const isTarget = targets.has(data.dim) || node === rootId;
    if (isTarget || kids.length > 0) return { ...data, isRoot: node === rootId, isCon: !isTarget, children: kids.length > 0 ? kids : null };
    return null;
}

document.getElementById('btnGenerate').onclick = () => {
    if(!RAW) return alert("Por favor, suba o arquivo Excel primeiro clicando no bot√£o no topo do menu lateral.");
    const rootId = document.getElementById('rootSelect').value;
    const targets = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    const treeData = build(rootId, targets, rootId);
    
    gMain.selectAll("*").remove();
    const root = d3.hierarchy(treeData);
    d3.tree().nodeSize([250, 160])(root);

    gMain.selectAll(".link").data(root.links()).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    const node = gMain.selectAll(".node").data(root.descendants()).enter().append("g")
        .attr("class", d => `node ${d.data.isCon ? 'node--connector' : ''} ${d.data.isRoot ? 'node--is-root' : ''}`)
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseover", showTooltip).on("mouseout", () => d3.select("#tooltip").style("display", "none"));

    node.each(function(d) {
        const g = d3.select(this);
        const txt = g.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
        const w = Math.max(160, txt.node().getBBox().width + 30), h = 42;
        const col = d.data.isCon ? "#fff" : getCol(d.data.dim);
        g.insert("rect", "text").attr("width", w).attr("height", h).attr("x", -w/2).attr("y", -h/2).attr("fill", col).attr("stroke", "#333");
        txt.style("fill", d.data.isCon ? "#101828" : "#fff");
    });
    
    const b = gMain.node().getBBox();
    const sc = Math.min(0.9, 0.9 / Math.max(b.width/svg.node().clientWidth, b.height/svg.node().clientHeight));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(svg.node().clientWidth/2 - (b.x + b.width/2)*sc, 60).scale(sc));
};

function showTooltip(e, d) {
    d3.select("#tooltip").style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
     .html(`
        <b style="color:#f97316; font-size:14px; display:block; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px;">${d.data.name}</b>
        <b>DIMENS√ÉO:</b> ${d.data.dim}<br><br>
        <b>COMENT√ÅRIO:</b><br>${d.data.comment}<br><br>
        ${d.data.obs ? `<b>OBSERVA√á√ïES:</b><br>${d.data.obs}` : ''}
     `);
}

document.getElementById('btnExport').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(serializer.serializeToString(svgEl))));
    img.onload = function() {
        const canvas = document.createElement("canvas");
        const sc = 3;
        canvas.width = svgEl.clientWidth * sc; canvas.height = svgEl.clientHeight * sc;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.scale(sc, sc); ctx.drawImage(img, 0, 0);
        const link = document.createElement("a");
        link.download = "ontoHate_simulacao.png"; link.href = canvas.toDataURL("image/png"); link.click();
    };
};
</script>
</body>
</html>
