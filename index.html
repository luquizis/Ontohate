<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taxonomy Builder Pro ‚Äî Generalista</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #f8fafc; --text: #0f172a; --line: #e2e8f0;
      --accent: #2563eb; --radius: 10px;
    }
    [data-theme="dark"] {
      --bg: #000000; --panel: #0f172a; --text: #f1f5f9; --line: #1e293b;
    }
    
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Arial, sans-serif; overflow: hidden; }
    
    header {
      background: var(--panel); border-bottom: 1px solid var(--line);
      padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
      height: 70px; box-sizing: border-box; z-index: 100;
    }

    .controls { display: flex; gap: 10px; align-items: center; }
    .btn {
      background: var(--bg); border: 1px solid var(--line); color: var(--text);
      padding: 8px 14px; border-radius: var(--radius); cursor: pointer; font-size: 11px; font-weight: bold;
      text-transform: uppercase; transition: 0.2s;
    }
    .btn:hover { filter: brightness(0.9); }
    .primary { background: var(--accent); color: #fff; border: none; }

    #wrap { display: flex; height: calc(100% - 70px); }
    .sidebar { width: 360px; background: var(--panel); border-right: 1px solid var(--line); overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .canvas-area { flex: 1; position: relative; background: var(--bg); }
    
    svg { width: 100%; height: 100%; }
    .link { fill: none; stroke: #94a3b8; stroke-width: 1.5px; opacity: 0.5; }
    .node rect { stroke-width: 1.2px; rx: 6; ry: 6; }
    .node text { font-family: Arial, sans-serif; font-weight: bold; pointer-events: none; }

    .tooltip {
      position: fixed; background: rgba(255,255,255,0.98); border: 1px solid var(--line); padding: 12px;
      border-radius: 8px; color: #1e293b; pointer-events: none; font-size: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; display: none; max-width: 300px;
    }

    .config-group { margin-bottom: 20px; }
    .dim-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; font-weight: bold; }
    select, input[type="text"] { width: 100%; padding: 8px; border-radius: 5px; background: var(--bg); color: var(--text); border: 1px solid var(--line); margin-top: 5px; }
    
    h3 { font-size: 13px; margin: 0 0 10px 0; border-bottom: 1px solid var(--line); padding-bottom: 5px; }
  </style>
</head>
<body data-theme="light">

<header>
  <div class="controls">
    <label class="btn primary">üìÅ CARREGAR ARQUIVO (XLSX/CSV) <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none"></label>
    <select id="themeSelect" class="btn" style="width: auto;">
      <option value="light">MODO CLARO</option>
      <option value="dark">MODO ESCURO</option>
    </select>
  </div>
  <div class="controls">
    <select id="layoutSelect" class="btn" style="width: auto;">
      <option value="topdown">VERTICAL (TOP-DOWN)</option>
      <option value="horizontal">HORIZONTAL</option>
      <option value="radial">RADIAL (360¬∞)</option>
    </select>
    <button class="btn primary" id="btnExportPng">üíæ EXPORTAR PNG (A4/ARTIGO)</button>
  </div>
</header>

<div id="wrap">
  <div class="sidebar">
    <div class="config-group">
      <h3>1. SELECIONAR DIMENS√ïES (ABAS)</h3>
      <div id="dimList">Nenhum dado carregado.</div>
    </div>

    <div class="config-group">
      <h3>2. DEFINIR RAIZ (TOPO)</h3>
      <select id="rootSelect"></select>
    </div>

    <div class="config-group">
      <h3>3. DEFINIR COPA (LIMITE)</h3>
      <p style="font-size: 10px; opacity: 0.7;">A taxonomia parar√° na classe selecionada.</p>
      <select id="canopySelect">
        <option value="">Sem limite (Copa livre)</option>
      </select>
    </div>

    <button class="btn primary" id="btnGenerate" style="width:100%; padding: 15px;">GERAR TAXONOMIA</button>
    <div id="infoBox" style="font-size: 11px; margin-top: 15px; line-height: 1.4;"></div>
  </div>
  
  <div class="canvas-area">
    <svg id="svg"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
</div>

<script>
let DATA_STORE = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

function getContrastColor(hex) {
  const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
  return (r*0.299 + g*0.587 + b*0.114) > 186 ? "#000000" : "#ffffff";
}

function getPaletteColor(str) {
  const colors = ["#2563eb", "#7c3aed", "#ea580c", "#059669", "#dc2626", "#0891b2", "#4f46e5", "#be185d"];
  let hash = 0;
  for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
  return colors[Math.abs(hash) % colors.length];
}

// Processador de Arquivos Generalista
async function handleFile(file) {
  const reader = new FileReader();
  reader.onload = async (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    
    const nodes = new Map(), dimensions = new Set(), hierarchy = new Map();

    workbook.SheetNames.forEach(sheet => {
      const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
      rows.forEach(row => {
        // Tenta identificar colunas dinamicamente (Classe e Pai)
        const keys = Object.keys(row);
        const name = row[keys.find(k => /classe|item|termo|name/i.test(k))] || "";
        const parent = row[keys.find(k => /super|pai|parent|origem/i.test(k))] || "";
        const dim = sheet;

        if (name) {
          nodes.set(name, { 
            name, 
            dim, 
            meta: row, 
            color: getPaletteColor(dim) 
          });
          dimensions.add(dim);
          if (parent && parent !== name) {
            if (!hierarchy.has(parent)) hierarchy.set(parent, []);
            if (!hierarchy.get(parent).includes(name)) hierarchy.get(parent).push(name);
          }
        }
      });
    });

    DATA_STORE = { nodes, dimensions: Array.from(dimensions).sort(), hierarchy };
    refreshUI();
  };
  reader.readAsArrayBuffer(file);
}

function refreshUI() {
  const dimDiv = d3.select("#dimList").html("");
  DATA_STORE.dimensions.forEach(d => {
    const lbl = dimDiv.append("label").attr("class", "dim-item");
    lbl.append("input").attr("type", "checkbox").attr("checked", true).attr("value", d);
    lbl.append("span").text(d).style("color", DATA_STORE.nodes.get(Array.from(DATA_STORE.nodes.keys()).find(k => DATA_STORE.nodes.get(k).dim === d)).color);
  });

  const names = Array.from(DATA_STORE.nodes.keys()).sort();
  const rootSel = d3.select("#rootSelect").html("");
  const canopySel = d3.select("#canopySelect").html('<option value="">Sem limite (Copa livre)</option>');
  
  names.forEach(n => {
    rootSel.append("option").text(n).attr("value", n);
    canopySel.append("option").text(n).attr("value", n);
  });
  
  d3.select("#infoBox").html(`<b>Arquivo Processado</b><br>Itens: ${DATA_STORE.nodes.size}<br>Dimens√µes: ${DATA_STORE.dimensions.length}`);
}

function generate() {
  if (!DATA_STORE) return alert("Suba um arquivo primeiro.");
  gMain.selectAll("*").remove();

  const layout = d3.select("#layoutSelect").property("value");
  const rootName = d3.select("#rootSelect").property("value");
  const canopyName = d3.select("#canopySelect").property("value");
  const activeDims = new Set();
  d3.selectAll("#dimList input:checked").each(function() { activeDims.add(this.value); });

  function build(name, visited = new Set()) {
    if (visited.has(name)) return null;
    visited.add(name);
    
    const nodeData = DATA_STORE.nodes.get(name);
    const isVisible = activeDims.has(nodeData.dim);
    
    // L√≥gica de Copa: se for o limite, n√£o busca filhos
    const children = (name === canopyName) ? [] : (DATA_STORE.hierarchy.get(name) || [])
      .map(c => build(c, new Set(visited)))
      .filter(Boolean);

    return { ...nodeData, children, isVisible };
  }

  const rootNode = build(rootName);
  if (!rootNode) return;

  const hData = d3.hierarchy(rootNode);
  let tree;
  if(layout === "radial") tree = d3.tree().size([2 * Math.PI, 350]);
  else if(layout === "horizontal") tree = d3.tree().nodeSize([45, 250]);
  else tree = d3.tree().nodeSize([250, 150]);

  tree(hData);

  const linkGen = layout === "radial" ? d3.linkRadial().angle(d => d.x).radius(d => d.y) :
                  layout === "horizontal" ? d3.linkHorizontal().x(d => d.y).y(d => d.x) :
                  d3.linkVertical().x(d => d.x).y(d => d.y);

  gMain.selectAll(".link").data(hData.links()).enter().append("path").attr("class", "link").attr("d", linkGen);

  const nodes = gMain.selectAll(".node").data(hData.descendants()).enter().append("g")
    .attr("class", "node")
    .attr("transform", d => {
      if(layout === "radial") return `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`;
      return layout === "horizontal" ? `translate(${d.y},${d.x})` : `translate(${d.x},${d.y})`;
    })
    .on("mouseenter", (e, d) => {
      const metaHtml = Object.entries(d.data.meta).map(([k,v]) => `<b>${k}:</b> ${v}`).join("<br>");
      d3.select("#tooltip").style("display", "block").html(metaHtml);
    })
    .on("mousemove", (e) => d3.select("#tooltip").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px"))
    .on("mouseleave", () => d3.select("#tooltip").style("display", "none"));

  nodes.append("rect").attr("x", -100).attr("y", -20).attr("width", 200).attr("height", 40)
    .attr("fill", d => d.data.isVisible ? d.data.color : "#cbd5e1")
    .attr("stroke", "#64748b");

  nodes.append("text").attr("text-anchor", "middle").attr("dy", 6)
    .attr("fill", d => getContrastColor(d.data.isVisible ? d.data.color : "#cbd5e1"))
    .style("font-size", "12px").text(d => d.data.name.substring(0, 25));

  const svgRect = svg.node().getBoundingClientRect();
  svg.call(zoom.transform, d3.zoomIdentity.translate(svgRect.width/2, 100).scale(0.7));
}

// Exporta√ß√£o PNG Pro
d3.select("#btnExportPng").on("click", () => {
  const svgNode = document.getElementById("svg");
  const bbox = gMain.node().getBBox();
  const canvas = document.createElement("canvas");
  const scale = 3, pad = 100;
  canvas.width = (bbox.width + pad*2) * scale;
  canvas.height = (bbox.height + pad*2) * scale;
  const ctx = canvas.getContext("2d");
  ctx.scale(scale, scale);
  ctx.fillStyle = document.body.dataset.theme === "dark" ? "#000000" : "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const svgData = new XMLSerializer().serializeToString(svgNode);
  const img = new Image();
  img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgData);
  img.onload = () => {
    ctx.drawImage(img, pad - bbox.x, pad - bbox.y);
    const a = document.createElement("a");
    a.download = `taxonomia_generalista_${Date.now()}.png`;
    a.href = canvas.toDataURL("image/png", 1.0);
    a.click();
  };
});

d3.select("#btnGenerate").on("click", generate);
d3.select("#themeSelect").on("change", function() { document.body.dataset.theme = this.value; });
d3.select("#fileInput").on("change", (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); });
</script>
</body>
</html>
