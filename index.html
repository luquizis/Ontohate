<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.2 ‚Äî Visualizador de Ontologia Cient√≠fica</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc; --highlight: #f97316;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: "Inter", "Segoe UI", system-ui, sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 1px 3px rgba(16,24,40,0.05);
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--text); }
    .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; margin-left: 10px; }
    .status-ok { background: #ecfdf3; color: #027a48; }
    .status-err { background: #fef3f2; color: #b42318; }

    .controls { display: flex; gap: 10px; }
    .btn, .select {
      border: 1px solid var(--line); background: #fff; color: var(--text); 
      border-radius: 6px; padding: 8px 14px; font-size: 12px; 
      cursor: pointer; transition: 0.2s; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #f9fafb; border-color: #d0d5dd; }
    .btn.primary { background: var(--text); color: #fff; border-color: var(--text); }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 380px; }
    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
    }

    .section-title { font-size: 13px; font-weight: 700; margin-bottom: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; overflow: hidden; }
    .dimItems { max-height: 250px; overflow-y: auto; padding: 6px; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 8px; font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.1s; }
    .dimItem:hover { background: #f2f4f7; }

    /* Estilo dos N√≥s no Gr√°fico */
    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; opacity: 0.6; }
    .node rect { stroke-width: 1.5px; rx: 5; ry: 5; }
    .node text { font-size: 11px; font-weight: 700; pointer-events: none; }
    
    /* Destaque para a Raiz Escolhida */
    .node--is-root rect { stroke: var(--highlight) !important; stroke-width: 3px !important; filter: drop-shadow(0 0 5px rgba(249,115,22,0.3)); }
    .node--connector rect { stroke-dasharray: 4,4; fill: #f9fafb !important; stroke: #d0d5dd !important; }
    .node--connector text { fill: #667085 !important; }

    /* Tooltip */
    .tooltip {
      position: fixed; display: none; z-index: 1000; background: #101828; color: #fff; 
      padding: 12px; border-radius: 8px; font-size: 12px; max-width: 300px; line-height: 1.5;
    }
    .tooltip b { color: #84adff; font-size: 14px; display: block; margin-bottom: 4px; }
    .tooltip i { font-style: normal; color: #98a2b3; font-size: 10px; display: block; margin-bottom: 8px; border-bottom: 1px solid #344054; padding-bottom: 4px; }

    .loader { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 100; font-weight: 700; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE <small>v3.2</small></h1>
    <span id="loadStatus" class="status-badge">Verificando Ontohate_V2.xlsx...</span>
  </div>

  <div class="controls">
    <div class="btn" id="btnReset">üéØ Resetar</div>
    <div class="btn primary" id="btnExport">üì∏ Exportar PNG/Artigo</div>
    <input type="file" id="fileBackup" style="display:none" accept=".xlsx">
  </header>

<div id="wrap">
  <div class="canvas">
    <div id="loader" class="loader">Calculando Hierarquia...</div>
    <svg id="svg"></svg>
  </div>
  
  <div class="side">
    <section>
        <div class="section-title">1. Dimens√µes Eleitas</div>
        <div class="dimList">
            <div class="dimItems" id="dimItems">Aguardando dados...</div>
        </div>
        <div style="margin-top:8px; display:flex; gap:5px;">
            <button class="btn" onclick="toggleAllDims(true)" style="padding:4px 8px; font-size:10px;">Todas</button>
            <button class="btn" onclick="toggleAllDims(false)" style="padding:4px 8px; font-size:10px;">Nenhuma</button>
        </div>
    </section>

    <section>
        <div class="section-title">2. Termo Raiz (Destaque)</div>
        <select id="rootSelect" class="select" style="width:100%; margin-bottom:12px;"></select>
        <button class="btn primary" id="btnGenerate" style="width:100%; justify-content:center;">Gerar Nova Simula√ß√£o</button>
    </section>

    <div style="font-size: 11px; color: var(--muted); background: #f2f4f7; padding: 12px; border-radius: 8px; line-height: 1.4;">
        <strong>Nota Cient√≠fica:</strong> Termos em cinza tracejado n√£o pertencem √†s dimens√µes selecionadas, mas foram inclu√≠dos automaticamente para permitir a conex√£o l√≥gica at√© a raiz escolhida.
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
let RAW = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.02, 3]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

// Normaliza√ß√£o para unificar dimens√µes (Singular/Plural)
function normalizeDim(dim) {
    let d = String(dim || "Geral").trim();
    const normalized = d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (normalized.includes("motivacao e consequencia")) return "Motiva√ß√£o e consequ√™ncia";
    return d;
}

// Carregamento Autom√°tico
async function init() {
    try {
        const response = await fetch('Ontohate_V2.xlsx');
        if (!response.ok) throw new Error();
        const arrayBuffer = await response.arrayBuffer();
        processData(arrayBuffer);
        document.getElementById('loadStatus').textContent = "Arquivo Integrado";
        document.getElementById('loadStatus').className = "status-badge status-ok";
    } catch (e) {
        document.getElementById('loadStatus').textContent = "Arquivo n√£o encontrado (Use Backup)";
        document.getElementById('loadStatus').className = "status-badge status-err";
        document.getElementById('loadStatus').onclick = () => document.getElementById('fileBackup').click();
    }
}

function processData(buffer) {
    const wb = XLSX.read(buffer);
    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    
    const nodes = new Map(), childrenMap = new Map(), dims = new Set();

    data.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = normalizeDim(row.Dimens√£o || row.Subontologia || "Geral");

        if(!name) return;
        nodes.set(name, { 
            name, dim, 
            comment: row.Comment || row.Comments || "Sem descri√ß√£o.",
            obs: row.Observa√ß√£o || row.Observa√ß√µes || "" 
        });
        dims.add(dim);

        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });

    RAW = { nodes, childrenMap, dims: Array.from(dims).sort() };
    setupUI();
}

function setupUI() {
    const container = document.getElementById('dimItems');
    container.innerHTML = RAW.dims.map(d => `
        <label class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:10px; height:10px; border-radius:50%; background:${getDimColor(d)}"></span>
            ${d}
        </label>
    `).join('');

    const select = document.getElementById('rootSelect');
    select.innerHTML = Array.from(RAW.nodes.keys()).sort().map(k => `<option value="${k}">${k}</option>`).join('');
}

function toggleAllDims(s) { document.querySelectorAll('.dim-check').forEach(i => i.checked = s); }

// L√≥gica de cores acad√™micas
function getDimColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360}, 60%, 45%)`;
}

function getContrast(hex){
    const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
    return ((r*299)+(g*587)+(b*114))/1000 > 155 ? '#000' : '#fff';
}

// Algoritmo de Busca de Caminhos Hier√°rquicos
function buildSimulation(nodeName, selectedDims, rootId, visited = new Set()) {
    if (visited.has(nodeName)) return null;
    visited.add(nodeName);

    const data = RAW.nodes.get(nodeName) || { name: nodeName, dim: "Conector" };
    const children = (RAW.childrenMap.get(nodeName) || [])
        .map(c => buildSimulation(c, selectedDims, rootId, visited))
        .filter(c => c !== null);

    const isTargetDim = selectedDims.has(data.dim);
    const isChosenRoot = nodeName === rootId;

    if (isTargetDim || isChosenRoot || children.length > 0) {
        return { 
            ...data, 
            isChosenRoot,
            isConnector: !isTargetDim && !isChosenRoot, 
            children: children.length > 0 ? children : null 
        };
    }
    return null;
}

function generate() {
    const rootName = document.getElementById('rootSelect').value;
    const selectedDims = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    
    document.getElementById('loader').style.display = 'flex';

    setTimeout(() => {
        const treeData = buildSimulation(rootName, selectedDims, rootName);
        if(!treeData) return alert("N√£o foi poss√≠vel gerar conex√£o entre os termos.");

        gMain.selectAll("*").remove();
        const root = d3.hierarchy(treeData);
        const layout = d3.tree().nodeSize([240, 150]);
        layout(root);

        // Desenhar Links
        gMain.selectAll(".link").data(root.links()).enter().append("path").attr("class", "link")
            .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

        // Desenhar N√≥s
        const node = gMain.selectAll(".node").data(root.descendants()).enter().append("g")
            .attr("class", d => `node ${d.data.isConnector ? 'node--connector' : ''} ${d.data.isChosenRoot ? 'node--is-root' : ''}`)
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .on("mouseover", showTooltip).on("mouseout", () => d3.select("#tooltip").style("display", "none"));

        node.each(function(d) {
            const g = d3.select(this);
            const label = g.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
            const b = label.node().getBBox();
            const w = Math.max(160, b.width + 30), h = 42;
            const color = d.data.isConnector ? "#ffffff" : getDimColor(d.data.dim);

            g.insert("rect", "text").attr("width", w).attr("height", h).attr("x", -w/2).attr("y", -h/2)
                .attr("fill", color).attr("stroke", d3.color(color).darker());
            
            label.style("fill", getContrast(d3.rgb(color).formatHex()));
        });

        fit();
        document.getElementById('loader').style.display = 'none';
    }, 100);
}

function fit() {
    const b = gMain.node().getBBox();
    const sw = svg.node().clientWidth, sh = svg.node().clientHeight;
    const scale = Math.min(0.9, 0.9 / Math.max(b.width/sw, b.height/sh));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(sw/2 - (b.x + b.width/2)*scale, 60).scale(scale));
}

function showTooltip(e, d) {
    const t = d3.select("#tooltip");
    t.style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
     .html(`<b>${d.data.name}</b><i>Dimens√£o: ${d.data.dim}</i><p>${d.data.comment}</p>${d.data.obs ? `<hr style="border:0;border-top:1px solid #344054;margin:8px 0"><span>${d.data.obs}</span>` : ''}`);
}

// Exporta√ß√£o PNG 300DPI para Artigos
document.getElementById('btnExport').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const xml = serializer.serializeToString(svgEl);
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
    img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = 3; // Multiplicador para qualidade de impress√£o
        canvas.width = svgEl.clientWidth * scale; canvas.height = svgEl.clientHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.scale(scale, scale); ctx.drawImage(img, 0, 0);
        const a = document.createElement("a");
        a.download = `ontoHate_figura_${Date.now()}.png`; a.href = canvas.toDataURL("image/png"); a.click();
    };
};

document.getElementById('btnGenerate').onclick = generate;
document.getElementById('btnReset').onclick = () => location.reload();
document.getElementById('fileBackup').onchange = e => {
    const r = new FileReader();
    r.onload = ev => processData(ev.target.result);
    r.readAsArrayBuffer(e.target.files[0]);
};

init();
</script>
</body>
</html>
