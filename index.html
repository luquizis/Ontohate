<script>
/* =========================
   OwlViz - VERSÃO CORRIGIDA E FUNCIONANDO
========================= */
class OwlViz {
  constructor() {
    this.owlData = null;
    this.uiState = { startA:'', rootB:'', selectedLeaves:[], activeBranches:new Set(), layout:'topdown', spacing:1.15, dragEnabled:false, showOnlyHighlighted:false };
    this.svg = d3.select("#svg"); this.gMain = this.svg.append("g");
    this.init();
  }

  init() {
    this.zoom = d3.zoom().scaleExtent([0.1,4]).on("zoom", e=>this.gMain.attr("transform", e.transform));
    this.svg.call(this.zoom);
    this.bindEvents();
  }

  // Helpers
  static escapeHtml(str) { return String(str??'').replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":"&#039;" }[m])); }
  static localName(iri) { const s=String(iri||''); const i=s.lastIndexOf('#'), j=s.lastIndexOf('/'); return Math.max(i,j)>=0?s.slice(Math.max(i,j)+1):s; }

  setStatus(msg, type='') {
    const el = document.getElementById("statusBox");
    el.className = `status ${type}`.trim(); el.innerHTML = msg;
  }

  setControlsEnabled(v) {
    document.querySelectorAll('[id^="btn"]:not(#fileInput)').forEach(btn=>btn.disabled=!v);
  }

  // Carregar OWL - CORRIGIDO
  async loadOwl(file) {
    try {
      this.setControlsEnabled(false); this.setStatus("Lendo OWL...", "");
      
      const text = await file.text();
      if(!text.includes('<rdf:RDF')) throw new Error("Não é RDF/XML (precisa ter <rdf:RDF>)");

      const store = window.$rdf.graph();
      $rdf.parse(text, store, 'urn:test', 'application/rdf+xml');

      const RDF = $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");
      const RDFS = $rdf.Namespace("http://www.w3.org/2000/01/rdf-schema#");
      const OWL = $rdf.Namespace("http://www.w3.org/2002/07/owl#");

      // Classes
      const classes = new Set([
        ...store.each(undefined, RDF('type'), OWL('Class')),
        ...store.each(undefined, RDF('type'), RDFS('Class'))
      ].map(t=>t.value));

      if(classes.size===0) throw new Error("Nenhuma owl:Class/rdfs:Class encontrada");

      // Nodes
      const nodes = new Map();
      for(let iri of classes) {
        const label = store.any($rdf.sym(iri), RDFS('label'))?.value || OwlViz.localName(iri);
        const comment = store.any($rdf.sym(iri), RDFS('comment'))?.value || '';
        nodes.set(iri, {iri, label, comment});
      }

      // Hierarquia
      const childrenMap = new Map();
      store.statementsMatching(undefined, RDFS('subClassOf'), undefined)
        .forEach(st => {
          const child = st.subject?.value, parent = st.object?.value;
          if(child && parent && nodes.has(child) && nodes.has(parent)) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, new Set());
            childrenMap.get(parent).add(child);
          }
        });

      this.owlData = { nodes, childrenMap };
      this.setStatus(`✅ ${nodes.size} classes, ${Array.from(childrenMap.values()).reduce((a,s)=>a+s.size,0)} relações`, 'ok');
      this.populateUI();
      this.setControlsEnabled(true);

    } catch(e) {
      this.setStatus(`❌ ${e.message}`, 'danger');
      console.error(e);
    }
  }

  populateUI() {
    const selA = d3.select("#startSelect").html("");
    const selB = d3.select("#rootSelect").html("");
    
    Array.from(this.owlData.nodes.values())
      .sort((a,b)=>a.label.localeCompare(b.label))
      .forEach(n => {
        selA.append("option").attr("value", n.iri).text(n.label);
        if(this.owlData.childrenMap.has(n.iri)) selB.append("option").attr("value", n.iri).text(n.label);
      });
  }

  // Render simples
  render() {
    if(!this.owlData?.nodes.has(this.uiState.startA) || !this.owlData?.nodes.has(this.uiState.rootB)) {
      this.setStatus("Selecione A e B válidos", "warn"); return;
    }

    this.gMain.selectAll("*").remove();

    // Árvore simples: A -> B -> todos os filhos de B
    const rootData = {
      label: this.owlData.nodes.get(this.uiState.startA).label, children: [{
        label: this.owlData.nodes.get(this.uiState.rootB).label,
        children: Array.from(this.owlData.childrenMap.get(this.uiState.rootB)||[]).map(iri=>({
          label: this.owlData.nodes.get(iri)?.label || OwlViz.localName(iri)
        }))
      }]
    };

    const root = d3.hierarchy(rootData);
    d3.tree().nodeSize([200,100])(root);

    // Links
    this.gMain.selectAll(".link")
      .data(root.links()).enter()
      .append("path").attr("class","link")
      .attr("d", d3.linkVertical().x(d=>d.x).y(d=>d.y));

    // Nodes
    this.gMain.selectAll(".node")
      .data(root.descendants()).enter()
      .append("g").attr("class","node")
      .attr("transform", d=>`translate(${d.x},${d.y})`)
      .append("rect")
      .attr("width",120).attr("height",40).attr("rx",8).attr("ry",8)
      .attr("fill","#f0f9ff").attr("stroke","#0369a1");

    this.gMain.selectAll(".node text")
      .data(root.descendants()).enter()
      .append("text").attr("text-anchor","middle").attr("dy","12")
      .text(d=>d.data.label);
  }

  bindEvents() {
    document.getElementById("fileInput").addEventListener("change", e=> {
      const file = e.target.files[0];
      if(file) this.loadOwl(file);
    });

    document.getElementById("btnGenerate").addEventListener("click", ()=>this.render());
    
    "#startSelect, #rootSelect".split(',').forEach(id=>
      document.getElementById(id.slice(1)).addEventListener("change", e=> {
        this.uiState[id.slice(1)] = e.target.value;
      })
    );
  }
}

// Inicializar
new OwlViz();
</script>
