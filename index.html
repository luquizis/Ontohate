<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V2 — Multi-Layout & Facetas</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #000000; /* Fundo escuro conforme imagem */
      --panel: #111111;
      --text: #ececec;
      --muted: #a1a1a1;
      --line: #333333;
      --accent: #22c55e;
      --shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
    
    header {
      background: rgba(17, 17, 17, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      padding: 10px 20px;
      display: flex; align-items: center; justify-content: space-between;
      height: 60px; box-sizing: border-box;
    }

    .controls { display: flex; gap: 10px; align-items: center; }
    .btn {
      background: var(--line); border: 1px solid #444; color: var(--text);
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px;
      transition: all 0.2s;
    }
    .btn:hover { background: #444; }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: bold; }

    #wrap { display: flex; height: calc(100% - 60px); }
    
    .sidebar {
      width: 320px; background: var(--panel); border-right: 1px solid var(--line);
      display: flex; flex-direction: column; transition: width 0.3s; overflow-y: auto;
    }
    .sidebar.collapsed { width: 0; overflow: hidden; border: none; }
    .side-content { padding: 20px; min-width: 300px; }

    .canvas-area { flex: 1; position: relative; overflow: hidden; }
    svg { width: 100%; height: 100%; cursor: grab; }
    svg:active { cursor: grabbing; }

    /* Estilo dos Nós inspirado na imagem */
    .node circle { stroke-width: 2px; }
    .node rect { rx: 6; ry: 6; cursor: pointer; }
    .node text { font-size: 11px; font-weight: 500; pointer-events: none; fill: #fff; }
    .link { fill: none; stroke: #444; stroke-width: 1.5px; opacity: 0.6; }

    .tooltip {
      position: fixed; background: rgba(20,20,20,0.95); border: 1px solid #444;
      padding: 10px; border-radius: 8px; color: #fff; pointer-events: none;
      font-size: 12px; box-shadow: var(--shadow); z-index: 1000; display: none;
    }

    .status-pill { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--muted); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

    select { background: #222; color: #fff; border: 1px solid #444; padding: 4px; border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <div class="status-pill">
    <div id="statusDot" class="dot"></div>
    <span id="statusText">Aguardando...</span>
  </div>
  <div class="controls">
    <select id="layoutSelect">
      <option value="horizontal">Layout Horizontal</option>
      <option value="vertical">Layout Vertical</option>
      <option value="radial">Layout Radial</option>
    </select>
    <button class="btn" id="btnFit">Ajustar Zoom</button>
    <button class="btn" id="btnDownload">Exportar SVG</button>
    <button class="btn" id="toggleSide">☰ Painel</button>
  </div>
</header>

<div id="wrap">
  <div class="sidebar" id="sidebar">
    <div class="side-content">
      <h3>Facetas (Dimensões)</h3>
      <div id="dimList"></div>
      <hr style="border:0; border-top:1px solid #333; margin: 20px 0;">
      <h3>Raiz</h3>
      <select id="rootSelect" style="width:100%"></select>
      <br><br>
      <button class="btn primary" id="btnGenerate" style="width:100%">Gerar Taxonomia</button>
    </div>
  </div>
  
  <div class="canvas-area">
    <svg id="svg"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
</div>

<script>
// Configuração GitHub
const GITHUB_URL = "https://raw.githubusercontent.com/seu-usuario/seu-repositorio/main/HateSpeechTaxonomy.xlsx";

let RAW_DATA = null;
let currentTreeData = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

async function init() {
    updateStatus("Buscando dados...", "active");
    try {
        const res = await fetch(GITHUB_URL);
        const arrayBuffer = await res.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        
        processData(json);
    } catch (e) {
        updateStatus("Erro ao carregar", "");
        console.error(e);
    }
}

function processData(json) {
    const nodes = new Map();
    const dimensions = new Set();
    const childrenMap = new Map();

    json.forEach(row => {
        const name = row.Classe || row.class;
        const parent = row.Superclasse || row.superclass;
        const dim = row.Dimensão || row.dimension || "Geral";
        
        if(name) {
            nodes.set(name, { name, dim, comment: row.Comment || "" });
            dimensions.add(dim);
            if(parent) {
                if(!childrenMap.has(parent)) childrenMap.set(parent, []);
                childrenMap.get(parent).push(name);
            }
        }
    });

    RAW_DATA = { nodes, dimensions: Array.from(dimensions), childrenMap };
    populateUI();
    updateStatus("Sincronizado", "active");
}

function populateUI() {
    const dimList = d3.select("#dimList");
    RAW_DATA.dimensions.forEach(dim => {
        const div = dimList.append("div").style("margin-bottom", "5px");
        div.append("input").attr("type", "checkbox").attr("checked", true).attr("value", dim);
        div.append("span").text(" " + dim).style("color", getDimColor(dim));
    });

    const rootSelect = d3.select("#rootSelect");
    Array.from(RAW_DATA.nodes.keys()).sort().forEach(n => {
        rootSelect.append("option").text(n).attr("value", n);
    });
}

function getDimColor(dim) {
    const colors = ["#3498db", "#9b59b6", "#e67e22", "#f1c40f", "#1abc9c", "#e74c3c"];
    let hash = 0;
    for (let i = 0; i < dim.length; i++) hash = dim.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
}

function generate() {
    const rootName = d3.select("#rootSelect").property("value");
    const selectedDims = new Set();
    d3.selectAll("#dimList input:checked").each(function() { selectedDims.add(this.value); });

    function build(name) {
        const node = RAW_DATA.nodes.get(name);
        if(!selectedDims.has(node.dim) && name !== rootName) return null;
        
        const children = (RAW_DATA.childrenMap.get(name) || [])
            .map(c => build(c))
            .filter(c => c !== null);
            
        return { ...node, children };
    }

    currentTreeData = d3.hierarchy(build(rootName));
    render();
}

function render() {
    gMain.selectAll("*").remove();
    const layoutType = d3.select("#layoutSelect").property("value");
    const width = window.innerWidth - 320;
    const height = window.innerHeight - 60;

    let treeLayout;
    if(layoutType === "radial") {
        treeLayout = d3.tree().size([2 * Math.PI, Math.min(width, height) / 2 - 100]);
    } else if(layoutType === "vertical") {
        treeLayout = d3.tree().size([width - 100, height - 200]);
    } else {
        treeLayout = d3.tree().size([height - 100, width - 300]);
    }

    treeLayout(currentTreeData);

    const linkGen = layoutType === "radial" 
        ? d3.linkRadial().angle(d => d.x).radius(d => d.y)
        : layoutType === "vertical"
            ? d3.linkVertical().x(d => d.x).y(d => d.y)
            : d3.linkHorizontal().x(d => d.y).y(d => d.x);

    gMain.selectAll(".link")
        .data(currentTreeData.links())
        .enter().append("path")
        .attr("class", "link")
        .attr("d", linkGen);

    const node = gMain.selectAll(".node")
        .data(currentTreeData.descendants())
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", d => {
            if(layoutType === "radial") {
                return `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`;
            }
            return layoutType === "vertical" ? `translate(${d.x},${d.y})` : `translate(${d.y},${d.x})`;
        });

    node.append("circle")
        .attr("r", 5)
        .attr("fill", d => getDimColor(d.data.dim));

    node.append("rect")
        .attr("x", 10)
        .attr("y", -12)
        .attr("width", d => d.data.name.length * 8 + 10)
        .attr("height", 24)
        .attr("fill", d => getDimColor(d.data.dim))
        .attr("opacity", 0.8);

    node.append("text")
        .attr("x", 15)
        .attr("dy", 4)
        .text(d => d.data.name);
}

function updateStatus(text, cls) {
    document.getElementById("statusText").innerText = text;
    document.getElementById("statusDot").className = "dot " + cls;
}

// Eventos
d3.select("#btnGenerate").on("click", generate);
d3.select("#btnFit").on("click", () => svg.transition().call(zoom.scaleTo, 0.8));
d3.select("#toggleSide").on("click", () => d3.select("#sidebar").classed("collapsed", !d3.select("#sidebar").classed("collapsed")));

init();
</script>
</body>
</html>
