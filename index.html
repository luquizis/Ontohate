<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Taxonomy Builder Pro ‚Äî Generalista Fix</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg: #ffffff; --panel: #f8fafc; --text: #0f172a; --line: #e2e8f0; --accent: #2563eb; --radius: 10px; }
    [data-theme="dark"] { --bg: #000000; --panel: #0f172a; --text: #f1f5f9; --line: #1e293b; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Arial, sans-serif; overflow: hidden; }
    header { background: var(--panel); border-bottom: 1px solid var(--line); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; height: 70px; box-sizing: border-box; }
    .controls { display: flex; gap: 10px; align-items: center; }
    .btn { background: var(--bg); border: 1px solid var(--line); color: var(--text); padding: 8px 14px; border-radius: var(--radius); cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    #wrap { display: flex; height: calc(100% - 70px); }
    .sidebar { width: 360px; background: var(--panel); border-right: 1px solid var(--line); overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .canvas-area { flex: 1; position: relative; background: var(--bg); }
    svg { width: 100%; height: 100%; }
    .link { fill: none; stroke: #94a3b8; stroke-width: 1.5px; opacity: 0.4; }
    .node rect { stroke-width: 1.2px; rx: 6; ry: 6; }
    .node text { font-family: Arial, sans-serif; font-weight: bold; pointer-events: none; font-size: 12px; }
    .tooltip { position: fixed; background: rgba(255,255,255,0.98); border: 1px solid var(--line); padding: 12px; border-radius: 8px; color: #1e293b; display: none; z-index: 1000; max-width: 300px; font-size: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body data-theme="light">
<header>
  <div class="controls">
    <label class="btn" style="background:var(--accent); color:#fff; border:none;">üìÅ CARREGAR XLSX <input type="file" id="fileInput" accept=".xlsx" style="display:none"></label>
    <select id="themeSelect" class="btn"><option value="light">MODO CLARO</option><option value="dark">MODO ESCURO</option></select>
  </div>
  <div class="controls">
    <select id="layoutSelect" class="btn">
      <option value="topdown">TOP-DOWN</option>
      <option value="horizontal">HORIZONTAL</option>
      <option value="radial">RADIAL</option>
    </select>
    <button class="btn" id="btnExportPng" style="background:var(--accent); color:#fff; border:none;">üíæ SALVAR PNG</button>
  </div>
</header>
<div id="wrap">
  <div class="sidebar">
    <h3>1. DIMENS√ïES</h3>
    <div id="dimList">Aguardando arquivo...</div>
    <hr>
    <h3>2. RAIZ (IN√çCIO)</h3>
    <select id="rootSelect"></select>
    <hr>
    <h3>3. COPA (FIM)</h3>
    <select id="canopySelect"><option value="">Sem limite</option></select>
    <br><br>
    <button class="btn" id="btnGenerate" style="width:100%; background:var(--accent); color:#fff; border:none; padding:15px;">GERAR TAXONOMIA</button>
  </div>
  <div class="canvas-area">
    <svg id="svg"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
</div>

<script>
let STORE = null;
const svg = d3.select("#svg"), gMain = svg.append("g");
const zoom = d3.zoom().on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

function getContrast(hex) {
  const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
  return (r*299 + g*587 + b*114)/1000 >= 128 ? "#000000" : "#ffffff";
}

function getColor(s) {
  const pal = ["#2563eb", "#7c3aed", "#ea580c", "#059669", "#dc2626", "#0891b2"];
  let h = 0; for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
  return pal[Math.abs(h) % pal.length];
}

async function handleFile(f) {
  const data = await f.arrayBuffer();
  const wb = XLSX.read(data, {type: 'array'});
  const nodes = new Map(), dimensions = new Set(), hierarchy = new Map();

  wb.SheetNames.forEach(sheet => {
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);
    rows.forEach(row => {
      const keys = Object.keys(row);
      const name = String(row[keys.find(k => /classe|item|name/i.test(k))] || "").trim();
      const parent = String(row[keys.find(k => /super|pai|parent/i.test(k))] || "").trim();
      const dim = sheet;
      if (name) {
        nodes.set(name, { name, dim, meta: row, color: getColor(dim) });
        dimensions.add(dim);
        if (parent && parent !== name) {
          if (!hierarchy.has(parent)) hierarchy.set(parent, []);
          hierarchy.get(parent).push(name);
        }
      }
    });
  });
  STORE = { nodes, dimensions: Array.from(dimensions).sort(), hierarchy };
  const dList = d3.select("#dimList").html("");
  STORE.dimensions.forEach(d => {
    const l = dList.append("label").attr("class", "dim-item").style("display","block").style("margin-bottom","5px");
    l.append("input").attr("type","checkbox").attr("checked",true).attr("value",d);
    l.append("span").text(" "+d).style("color", getColor(d)).style("font-weight","bold");
  });
  const rSel = d3.select("#rootSelect").html(""), cSel = d3.select("#canopySelect").html('<option value="">Sem limite</option>');
  Array.from(STORE.nodes.keys()).sort().forEach(n => {
    rSel.append("option").text(n).attr("value",n);
    cSel.append("option").text(n).attr("value",n);
  });
}

function render() {
  if(!STORE) return;
  gMain.selectAll("*").remove();
  const layout = d3.select("#layoutSelect").property("value"), rootName = d3.select("#rootSelect").property("value"), canopyName = d3.select("#canopySelect").property("value");
  const activeDims = new Set(); d3.selectAll("#dimList input:checked").each(function(){ activeDims.add(this.value); });

  function build(name, visited = new Set()) {
    if (visited.has(name)) return null; visited.add(name);
    const node = STORE.nodes.get(name);
    // L√≥gica inclusiva: se o n√≥ ou algum descendente pertencer √† dimens√£o, ele aparece. 
    // Se n√£o pertencer, aparece em cinza.
    const children = (name === canopyName) ? [] : (STORE.hierarchy.get(name) || []).map(c => build(c, new Set(visited))).filter(Boolean);
    return { ...node, children, isHighlighted: activeDims.has(node.dim) };
  }

  const hRoot = d3.hierarchy(build(rootName));
  let tree = layout === "radial" ? d3.tree().size([2 * Math.PI, 350]) : (layout === "horizontal" ? d3.tree().nodeSize([50, 260]) : d3.tree().nodeSize([260, 160]));
  tree(hRoot);

  const lGen = layout === "radial" ? d3.linkRadial().angle(d => d.x).radius(d => d.y) : (layout === "horizontal" ? d3.linkHorizontal().x(d => d.y).y(d => d.x) : d3.linkVertical().x(d => d.x).y(d => d.y));
  gMain.selectAll(".link").data(hRoot.links()).enter().append("path").attr("class", "link").attr("d", lGen);

  const nodes = gMain.selectAll(".node").data(hRoot.descendants()).enter().append("g").attr("class", "node")
    .attr("transform", d => layout === "radial" ? `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)` : (layout === "horizontal" ? `translate(${d.y},${d.x})` : `translate(${d.x},${d.y})`))
    .on("mouseenter", (e, d) => {
      d3.select("#tooltip").style("display", "block").html(Object.entries(d.data.meta).map(([k,v]) => `<b>${k}:</b> ${v}`).join("<br>"));
    }).on("mousemove", (e) => d3.select("#tooltip").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")).on("mouseleave", () => d3.select("#tooltip").style("display", "none"));

  nodes.append("rect").attr("x", -110).attr("y", -20).attr("width", 220).attr("height", 40)
    .attr("fill", d => d.data.isHighlighted ? d.data.color : "#cbd5e1").attr("stroke", "#64748b");

  nodes.append("text").attr("text-anchor", "middle").attr("dy", 6).attr("fill", d => getContrast(d.data.isHighlighted ? d.data.color : "#cbd5e1"))
    .text(d => d.data.name.substring(0, 24));

  const sRect = svg.node().getBoundingClientRect();
  svg.call(zoom.transform, d3.zoomIdentity.translate(sRect.width/2, 100).scale(0.7));
}

d3.select("#btnGenerate").on("click", render);
d3.select("#fileInput").on("change", (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); });
d3.select("#themeSelect").on("change", function(){ document.body.dataset.theme = this.value; });
d3.select("#btnExportPng").on("click", () => {
  const svgN = document.getElementById("svg"), bbox = gMain.node().getBBox(), canvas = document.createElement("canvas"), scale = 3, p = 100;
  canvas.width = (bbox.width + p*2) * scale; canvas.height = (bbox.height + p*2) * scale;
  const ctx = canvas.getContext("2d"); ctx.scale(scale, scale);
  ctx.fillStyle = document.body.dataset.theme === "dark" ? "#000" : "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  const img = new Image(); img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(new XMLSerializer().serializeToString(svgN));
  img.onload = () => { ctx.drawImage(img, p - bbox.x, p - bbox.y); const a = document.createElement("a"); a.download = `taxonomia_${Date.now()}.png`; a.href = canvas.toDataURL("image/png"); a.click(); };
});
</script>
</body>
</html>
