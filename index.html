<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.0 ‚Äî Visualizador Cient√≠fico</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: "Inter", "Segoe UI", sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 1px 3px rgba(16,24,40,0.05);
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--accent); }
    .brand span { font-size: 11px; color: var(--muted); }

    .controls { display: flex; gap: 10px; }
    
    .btn, .file, .input, .select {
      border: 1px solid var(--line); background: #fff;
      color: var(--text); border-radius: 6px; padding: 8px 14px;
      font-size: 12px; display: inline-flex; gap: 8px; align-items: center;
      cursor: pointer; transition: 0.2s; font-weight: 500;
    }
    .btn:hover { background: #f9fafb; border-color: #d0d5dd; }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 360px; }

    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
    }

    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; overflow: hidden; }
    .dimItems { max-height: 280px; overflow-y: auto; padding: 6px; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 8px; font-size: 12px; cursor: pointer; border-radius: 4px; }
    .dimItem:hover { background: #f2f4f7; }

    /* Estilos da Taxonomia (Foco em Legibilidade) */
    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; }
    .node rect { stroke-width: 1.5px; rx: 4; ry: 4; }
    .node text { font-size: 12px; font-weight: 600; pointer-events: none; }
    .node--connector rect { stroke-dasharray: 4,4; fill-opacity: 0.05; }
    .node--target rect { stroke-width: 2.5px; }

    /* Tooltip Acad√™mico */
    .tooltip {
      position: fixed; display: none; z-index: 1000;
      background: #101828; color: #fff; padding: 12px;
      border-radius: 8px; font-size: 12px; max-width: 320px;
      line-height: 1.5; box-shadow: 0 12px 16px -4px rgba(16,24,40,0.1);
    }
    .tooltip .t-name { color: #84adff; font-weight: 800; border-bottom: 1px solid #344054; padding-bottom: 5px; margin-bottom: 8px; font-size: 13px; }
    .tooltip .t-label { font-weight: 700; color: #98a2b3; text-transform: uppercase; font-size: 10px; margin-top: 8px; }

    .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 50; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V3.0</h1>
    <span>Gerador de Taxonomia para Publica√ß√µes Cient√≠ficas</span>
  </div>

  <div class="controls">
    <label class="file btn">üìÇ Abrir Ontohate_V2.xlsx <input id="fileInput" type="file" accept=".xlsx,.xls" /></label>
    <div class="btn" id="btnFit">üéØ Resetar Zoom</div>
    <div class="btn primary" id="btnPng">üì∏ Exportar (Alta Resolu√ß√£o)</div>
  </div>
</header>

<div id="wrap">
  <div class="canvas">
    <div id="loader" class="loading-overlay">‚öôÔ∏è Processando √Årvore Cient√≠fica...</div>
    <svg id="svg"></svg>
  </div>
  
  <div class="side">
    <section>
        <h3>1. Selecionar Dimens√µes</h3>
        <div class="dimList">
            <div class="dimItems" id="dimItems"></div>
        </div>
        <div style="margin-top: 8px; display: flex; gap: 5px;">
            <div class="btn" onclick="toggleAllDims(true)" style="padding: 4px 8px; font-size: 10px;">Check All</div>
            <div class="btn" onclick="toggleAllDims(false)" style="padding: 4px 8px; font-size: 10px;">Uncheck All</div>
        </div>
    </section>

    <section>
        <h3>2. Termo Raiz</h3>
        <select id="rootSelect" class="select" style="width:100%; margin-bottom:12px;"></select>
        <div class="btn primary" id="btnGenerate" style="width:100%; justify-content:center; font-size: 13px;">Gerar Taxonomia Top-Down</div>
    </section>

    <div style="margin-top: auto; padding: 15px; background: #f2f4f7; border-radius: 8px;">
        <p style="font-size: 11px; color: var(--muted); margin: 0;">
            <b>Legenda:</b><br>
            ‚Ä¢ Ret√¢ngulos cont√≠nuos: Termos das dimens√µes eleitas.<br>
            ‚Ä¢ Ret√¢ngulos tracejados: Termos conectores (necess√°rios para a hierarquia).
        </p>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
let RAW_DATA = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.02, 4]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

// 1. Unifica√ß√£o de Dimens√µes (Motiva√ß√£o e consequ√™ncia/s)
function cleanDim(dim) {
    let d = String(dim || "Geral").trim();
    if (d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes("motivacao e consequencia")) {
        return "Motiva√ß√£o e consequ√™ncia";
    }
    return d;
}

function getContrast(hex){
    const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
    const yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 150) ? '#101828' : '#ffffff';
}

function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360}, 65%, 40%)`;
}

// Carregamento do Arquivo
document.getElementById('fileInput').onchange = async function(e) {
    const file = e.target.files[0];
    if(!file) return;

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    const nodes = new Map(), childrenMap = new Map(), dims = new Set();

    json.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = cleanDim(row.Dimens√£o || row.Subontologia || "Geral");

        if(!name) return;
        nodes.set(name, { 
            name, dim, 
            comment: row.Comment || row.Comments || row.Observa√ß√£o || "",
            obs: row.Observa√ß√µes || row.Notas || ""
        });
        dims.add(dim);

        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });

    RAW_DATA = { nodes, childrenMap, dims: Array.from(dims).sort() };
    renderDimList();
    updateRoots();
};

function renderDimList() {
    const container = document.getElementById('dimItems');
    container.innerHTML = RAW_DATA.dims.map(d => `
        <label class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:10px; height:10px; border-radius:50%; background:${stringToColor(d)}"></span>
            ${d}
        </label>
    `).join('');
}

function toggleAllDims(state) {
    document.querySelectorAll('.dim-check').forEach(i => i.checked = state);
}

function updateRoots() {
    const select = document.getElementById('rootSelect');
    select.innerHTML = '<option value="">Selecione o termo raiz...</option>';
    // Adiciona todos os termos que possuem filhos como potenciais ra√≠zes
    RAW_DATA.nodes.forEach((v, k) => {
        if((RAW_DATA.childrenMap.get(k) || []).length > 0) {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = k;
            select.appendChild(opt);
        }
    });
}

// 3. Algoritmo de Intersec√ß√£o e Conex√£o Hier√°rquica
function buildAcademicTree(nodeName, selectedDims, visited = new Set()) {
    if (visited.has(nodeName)) return null;
    visited.add(nodeName);

    const nodeData = RAW_DATA.nodes.get(nodeName) || { name: nodeName, dim: "Geral" };
    const childrenNames = RAW_DATA.childrenMap.get(nodeName) || [];
    
    // Constr√≥i sub-√°rvores recursivamente
    const children = childrenNames
        .map(c => buildAcademicTree(c, selectedDims, visited))
        .filter(c => c !== null);

    const isTarget = selectedDims.has(nodeData.dim);

    // Regra: Mant√©m o n√≥ se ele for alvo OU se ele tiver descendentes que s√£o alvos
    if (isTarget || children.length > 0) {
        return { 
            ...nodeData, 
            isConnector: !isTarget, 
            children: children.length > 0 ? children : null 
        };
    }
    return null;
}

function render() {
    const rootName = document.getElementById('rootSelect').value;
    const selectedDims = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    
    if(!rootName) return alert("Selecione um termo raiz para iniciar a taxonomia.");

    document.getElementById('loader').style.display = 'flex';

    // Timer para permitir que o loader apare√ßa
    setTimeout(() => {
        const treeData = buildAcademicTree(rootName, selectedDims);
        if(!treeData) {
            document.getElementById('loader').style.display = 'none';
            return alert("Nenhum termo encontrado. Verifique as dimens√µes selecionadas.");
        }

        gMain.selectAll("*").remove();
        const root = d3.hierarchy(treeData);
        
        // Layout Top-Down din√¢mico
        const treeLayout = d3.tree().nodeSize([240, 140]);
        treeLayout(root);

        const links = root.links();
        const nodes = root.descendants();

        // 4. Renderiza√ß√£o com Foco em Legibilidade Cient√≠fica
        gMain.selectAll(".link").data(links).enter().append("path").attr("class", "link")
            .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

        const node = gMain.selectAll(".node").data(nodes).enter().append("g")
            .attr("class", d => `node ${d.data.isConnector ? 'node--connector' : 'node--target'}`)
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .on("mouseover", showTooltip)
            .on("mouseout", () => d3.select("#tooltip").style("display", "none"));

        node.each(function(d) {
            const group = d3.select(this);
            const text = group.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
            
            const bbox = text.node().getBBox();
            const rectW = Math.max(160, bbox.width + 30);
            const rectH = 40;

            const bgColor = d.data.isConnector ? "#ffffff" : stringToColor(d.data.dim);
            
            group.insert("rect", "text").attr("width", rectW).attr("height", rectH).attr("x", -rectW/2).attr("y", -rectH/2)
                .attr("fill", bgColor).attr("stroke", d.data.isConnector ? "#98a2b3" : d3.color(bgColor).darker());

            text.style("fill", getContrast(d3.rgb(bgColor).formatHex()));
        });

        autoFit();
        document.getElementById('loader').style.display = 'none';
    }, 50);
}

function autoFit() {
    const bounds = gMain.node().getBBox();
    const fullW = svg.node().clientWidth, fullH = svg.node().clientHeight;
    const midX = bounds.x + bounds.width / 2, midY = bounds.y + bounds.height / 2;
    const scale = Math.min(0.9, 0.9 / Math.max(bounds.width / fullW, bounds.height / fullH));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(fullW/2 - midX*scale, 60).scale(scale));
}

// 2. Tooltip Acad√™mico (Sem metadados t√©cnicos de ontologia)
function showTooltip(e, d) {
    const t = d3.select("#tooltip");
    t.style("display", "block")
     .style("left", (e.pageX + 15) + "px")
     .style("top", (e.pageY + 15) + "px")
     .html(`
        <div class="t-name">${d.data.name}</div>
        <div class="t-label">Coment√°rio</div>
        <div>${d.data.comment || 'Nenhum coment√°rio dispon√≠vel.'}</div>
        ${d.data.obs ? `<div class="t-label">Observa√ß√µes</div><div>${d.data.obs}</div>` : ''}
     `);
}

document.getElementById('btnGenerate').onclick = render;
document.getElementById('btnFit').onclick = autoFit;

// Exporta√ß√£o PNG (Alta Qualidade para Artigos)
document.getElementById('btnPng').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svgEl);
    
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
    
    img.onload = function() {
        const canvas = document.createElement("canvas");
        // Escala de 3x para garantir qualidade de impress√£o (300 DPI)
        const scale = 3;
        canvas.width = svgEl.clientWidth * scale;
        canvas.height = svgEl.clientHeight * scale;
        
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.scale(scale, scale);
        ctx.drawImage(img, 0, 0);
        
        const link = document.createElement("a");
        link.download = `taxonomia_ontohate_${Date.now()}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
    };
};
</script>
</body>
</html>
