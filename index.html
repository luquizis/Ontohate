<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.7 ‚Äî Visualiza√ß√£o Hier√°rquica Completa</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc; --highlight: #f97316;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--text); }
    #statusBadge { font-size: 10px; padding: 4px 12px; border-radius: 20px; font-weight: 700; background: #ecfdf3; color: #027a48; }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 400px; }
    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
    }

    .btn {
      border: 1px solid var(--line); background: #fff; color: var(--text); 
      border-radius: 8px; padding: 10px 16px; font-size: 12px; 
      cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn.primary { background: #101828; color: #fff; border-color: #101828; }

    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; max-height: 250px; overflow-y: auto; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 8px; font-size: 12px; border-bottom: 1px solid #f2f4f7; }

    .node rect { stroke-width: 1.5px; rx: 6; ry: 6; }
    .node text { font-size: 11px; font-weight: 700; pointer-events: none; }
    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; opacity: 0.5; }
    
    .node--is-root rect { stroke: var(--highlight) !important; stroke-width: 4px !important; }
    .node--connector rect { stroke-dasharray: 5,3; fill: #f9fafb !important; stroke: #d0d5dd !important; }

    .tooltip {
      position: fixed; display: none; z-index: 1000; background: #101828; color: #fff; 
      padding: 15px; border-radius: 8px; font-size: 12px; max-width: 320px; line-height: 1.5;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V3.7</h1>
    <span id="statusBadge">Base Integrada</span>
  </div>
  <div class="controls">
    <button class="btn" onclick="location.reload()">üîÑ Resetar Sistema</button>
    <button class="btn primary" id="btnExport">üì∏ Exportar Figura</button>
  </div>
</header>

<div id="wrap">
  <div class="canvas"><svg id="svg"></svg></div>
  <div class="side">
    <section>
        <h3 style="font-size:12px; margin:0 0 10px 0;">1. SELECIONAR DIMENS√ïES</h3>
        <div class="dimList" id="dimContainer"></div>
        <div style="display:flex; gap:5px; margin-top:8px;">
            <button class="btn" onclick="toggleDims(true)" style="padding:5px 10px">Todas</button>
            <button class="btn" onclick="toggleDims(false)" style="padding:5px 10px">Nenhuma</button>
        </div>
    </section>

    <section>
        <h3 style="font-size:12px; margin:0 0 10px 0;">2. TERMO RAIZ (TOPO)</h3>
        <select id="rootSelect" class="btn" style="width:100%; margin-bottom:12px; text-align:left;"></select>
        <button class="btn primary" id="btnGenerate" style="width:100%;">GERAR TAXONOMIA COMPLETA</button>
    </section>

    <div style="font-size: 11px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 15px;">
        <b>Regras de Visualiza√ß√£o:</b><br>
        ‚Ä¢ A raiz selecionada aparece no topo.<br>
        ‚Ä¢ Classes das dimens√µes marcadas aparecem coloridas.<br>
        ‚Ä¢ Classes de outras dimens√µes necess√°rias para conex√£o aparecem em cinza.
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
let RAW = null;
const svg = d3.select("#svg"), gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.01, 3]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

// Carregamento autom√°tico via fetch
async function loadAuto() {
    try {
        const response = await fetch('Ontohate_V2.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        processRows(rows);
    } catch (e) {
        console.error("Erro no carregamento autom√°tico. Use o console para depurar.");
    }
}

function processRows(rows) {
    const nodes = new Map(), childrenMap = new Map(), dims = new Set();
    rows.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = String(row.Dimens√£o || row.Subontologia || "Geral").trim();
        if(!name) return;
        nodes.set(name, { name, dim, comment: row.Comment || row.Comments || "", obs: row.Observa√ß√µes || "" });
        dims.add(dim);
        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });
    RAW = { nodes, childrenMap, dims: Array.from(dims).sort() };
    fillUI();
}

function fillUI() {
    document.getElementById('dimContainer').innerHTML = RAW.dims.map(d => `
        <div class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:8px; height:8px; border-radius:50%; background:${getCol(d)}"></span>
            ${d}
        </div>
    `).join('');
    document.getElementById('rootSelect').innerHTML = Array.from(RAW.nodes.keys()).sort().map(k => `<option value="${k}">${k}</option>`).join('');
}

function getCol(s) {
    let h = 0; for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
    return `hsl(${Math.abs(h)%360}, 65%, 45%)`;
}

function toggleDims(s) { document.querySelectorAll('.dim-check').forEach(i => i.checked = s); }

// L√≥gica de constru√ß√£o recursiva aprimorada
function buildTree(node, targets, rootId, visited = new Set()) {
    if (visited.has(node)) return null;
    visited.add(node);

    const data = RAW.nodes.get(node) || { name: node, dim: "Conector" };
    const kids = (RAW.childrenMap.get(node) || [])
        .map(c => buildTree(c, targets, rootId, new Set(visited)))
        .filter(c => c !== null);

    const isTarget = targets.has(data.dim) || node === rootId;

    if (isTarget || kids.length > 0) {
        return { 
            ...data, 
            isRoot: node === rootId, 
            isCon: !isTarget, 
            children: kids.length > 0 ? kids : null 
        };
    }
    return null;
}

document.getElementById('btnGenerate').onclick = () => {
    if(!RAW) return;
    const rootId = document.getElementById('rootSelect').value;
    const targets = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    const treeData = buildTree(rootId, targets, rootId);
    
    gMain.selectAll("*").remove();
    const root = d3.hierarchy(treeData);
    d3.tree().nodeSize([280, 180])(root); // Espa√ßamento maior para legibilidade

    gMain.selectAll(".link").data(root.links()).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    const node = gMain.selectAll(".node").data(root.descendants()).enter().append("g")
        .attr("class", d => `node ${d.data.isCon ? 'node--connector' : ''} ${d.data.isRoot ? 'node--is-root' : ''}`)
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseover", showTooltip).on("mouseout", () => d3.select("#tooltip").style("display", "none"));

    node.each(function(d) {
        const g = d3.select(this);
        const txt = g.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
        const w = Math.max(180, txt.node().getBBox().width + 40), h = 45;
        const col = d.data.isCon ? "#fff" : getCol(d.data.dim);
        g.insert("rect", "text").attr("width", w).attr("height", h).attr("x", -w/2).attr("y", -h/2).attr("fill", col).attr("stroke", "#333");
        txt.style("fill", d.data.isCon ? "#101828" : "#fff");
    });
    
    // Auto-ajuste de c√¢mera
    const b = gMain.node().getBBox();
    const sc = Math.min(0.9, 0.9 / Math.max(b.width/svg.node().clientWidth, b.height/svg.node().clientHeight));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(svg.node().clientWidth/2 - (b.x + b.width/2)*sc, 80).scale(sc));
};

function showTooltip(e, d) {
    d3.select("#tooltip").style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
     .html(`<b>${d.data.name}</b><br>Dimens√£o: ${d.data.dim}<br><br>${d.data.comment || d.data.obs || 'Sem descri√ß√£o.'}`);
}

loadAuto();
</script>
</body>
</html>
