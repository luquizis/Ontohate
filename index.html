<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OWL Taxonomy Builder - Ultra PRO</title>
  
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rdflib@2.2.37/dist/rdflib.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #f8fafc; --text: #0f172a; --muted: #64748b; --line: #e2e8f0; --accent: #2563eb;
    }
    [data-theme="dark"] {
      --bg: #020617; --panel: #0f172a; --text: #f1f5f9; --muted: #94a3b8; --line: #1e293b;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
    
    header { background: var(--panel); border-bottom: 1px solid var(--line); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 70px; z-index: 100; }
    .controls { display: flex; align-items: center; gap: 12px; }
    
    .btn { background: var(--bg); border: 1px solid var(--line); color: var(--text); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 700; text-transform: uppercase; transition: 0.2s; }
    .btn:hover { background: var(--line); }
    .btn.primary { background: var(--accent); color: #fff; border-color: transparent; }

    #wrap { display: flex; height: calc(100vh - 70px); }
    .sidebar { width: 360px; background: var(--panel); border-right: 1px solid var(--line); overflow-y: auto; padding: 20px; font-size: 13px; box-shadow: 4px 0 10px rgba(0,0,0,0.02); }
    .canvas-area { flex: 1; position: relative; background: var(--bg); overflow: hidden; }
    
    svg { width: 100%; height: 100%; cursor: grab; }
    svg:active { cursor: grabbing; }

    .section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--line); }
    h3 { margin: 0 0 10px 0; font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    select, input[type="text"], input[type="range"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--line); background: var(--bg); color: var(--text); margin-bottom: 10px; }
    
    .scroll-box { border: 1px solid var(--line); border-radius: 8px; background: var(--bg); padding: 8px; max-height: 120px; overflow-y: auto; }
    .item-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--line); font-size: 11px; }

    /* Estilos do Grafo */
    .link { fill: none; stroke: #cbd5e1; stroke-width: 1.5px; transition: stroke 0.3s; }
    .node rect { stroke-width: 2.5px; cursor: pointer; transition: 0.3s; }
    .node text { font-size: 11px; font-weight: 800; pointer-events: none; font-family: sans-serif; }
    .node.highlight rect { stroke: #ef4444 !important; stroke-width: 6px !important; }
  </style>
</head>

<body data-theme="light">

<header>
  <div class="controls">
    <label class="btn primary">ü¶â Abrir OWL <input type="file" id="fileInput" accept=".owl,.rdf,.xml" style="display:none"></label>
    <select id="themeSelect" class="btn" style="width:auto; margin:0">
      <option value="light">‚òÄÔ∏è Light</option>
      <option value="dark">üåô Dark</option>
    </select>
  </div>
  <div class="controls">
    <button class="btn primary" id="btnExportPng">üíæ Exportar PNG HD (A4)</button>
  </div>
</header>

<div id="wrap">
  <div class="sidebar">
    <div class="section">
      <h3>üîç Localizar Classe</h3>
      <input type="text" id="searchInput" placeholder="Digite o nome para destacar...">
    </div>

    <div class="section">
      <h3>üìê Configura√ß√µes de Layout</h3>
      <select id="layoutSelect">
        <option value="a4">üìÑ Otimizado para A4 (Compacto)</option>
        <option value="topdown">Vertical (Padr√£o)</option>
        <option value="horizontal">Horizontal</option>
        <option value="radial">Radial / Circular</option>
      </select>
      <label>Densidade (Espa√ßamento): <span id="spacingLabel">1.0</span></label>
      <input id="spacingRange" type="range" min="0.4" max="2.2" step="0.1" value="1.0">
      <label>Dimens√µes (Profundidade): <span id="depthLabel">3</span></label>
      <input id="depthRange" type="range" min="1" max="10" step="1" value="3">
    </div>

    <div class="section">
      <h3>üå≥ Estrutura da Taxonomia</h3>
      <label>N√≥ de Origem (A):</label><select id="startSelect"></select>
      <label>Raiz Focal (B):</label><select id="rootSelect"></select>
    </div>

    <div class="section">
      <h3>üåø Ramos Ativos (C)</h3>
      <div class="scroll-box" id="branchBox">Selecione o arquivo OWL...</div>
    </div>

    <button class="btn primary" id="btnGenerate" style="width:100%; padding:16px;">üé® Atualizar Visualiza√ß√£o</button>
  </div>

  <div class="canvas-area">
    <svg id="svg"></svg>
  </div>
</div>

<script>
class OwlViz {
  constructor() {
    this.owlData = null;
    this.uiState = { startA: '', rootB: '', activeBranches: new Set(), layout: 'a4', spacing: 1.0, maxDepth: 3 };
    
    // Cores por Dimens√£o
    this.dimColors = [
      {bg: "#e0f2fe", stroke: "#0369a1", text: "#0c4a6e"}, // N√≠vel 0
      {bg: "#fef3c7", stroke: "#b45309", text: "#78350f"}, // N√≠vel 1
      {bg: "#dcfce7", stroke: "#15803d", text: "#064e3b"}, // N√≠vel 2
      {bg: "#f3e8ff", stroke: "#7e22ce", text: "#4c1d95"}, // N√≠vel 3
      {bg: "#ffe4e6", stroke: "#be123c", text: "#881337"}, // N√≠vel 4
      {bg: "#f1f5f9", stroke: "#334155", text: "#0f172a"}  // N√≠vel 5+
    ];

    this.svg = d3.select('#svg');
    this.gMain = this.svg.append('g');
    this.zoom = d3.zoom().scaleExtent([0.05, 5]).on('zoom', e => this.gMain.attr('transform', e.transform));
    this.svg.call(this.zoom);
    this.bindEvents();
  }

  localName(iri) {
    if (!iri || iri.includes('genid')) return "Node";
    return iri.split(/[#\/]/).pop();
  }

  async loadOwl(file) {
    const text = await file.text();
    const store = $rdf.graph();
    try {
      $rdf.parse(text, store, 'urn:local', 'application/rdf+xml');
      const nodes = new Map();
      const childrenMap = new Map();
      const RDFS = $rdf.Namespace('http://www.w3.org/2000/01/rdf-schema#');
      
      const classes = store.each(undefined, $rdf.sym('http://www.w3.org/1999/02/22-rdf-syntax-ns#type'), $rdf.sym('http://www.w3.org/2002/07/owl#Class'))
        .filter(c => !c.value.includes('genid'));

      classes.forEach(c => {
        nodes.set(c.value, { iri: c.value, label: store.any(c, RDFS('label'))?.value || this.localName(c.value) });
      });

      store.statementsMatching(undefined, RDFS('subClassOf'), undefined).forEach(st => {
        if (nodes.has(st.subject.value) && nodes.has(st.object.value)) {
          if (!childrenMap.has(st.object.value)) childrenMap.set(st.object.value, []);
          childrenMap.get(st.object.value).push(st.subject.value);
        }
      });

      this.owlData = { nodes, childrenMap };
      this.populateUI();
    } catch (e) { alert("Erro ao processar OWL. Certifique-se de que √© RDF/XML."); }
  }

  populateUI() {
    const sorted = Array.from(this.owlData.nodes.values()).sort((a,b) => a.label.localeCompare(b.label));
    const selects = d3.selectAll('#startSelect, #rootSelect');
    selects.selectAll('option').remove();
    selects.selectAll('option').data(sorted).enter().append('option').attr('value', d => d.iri).text(d => d.label);

    this.uiState.startA = sorted[0].iri;
    this.uiState.rootB = sorted[0].iri;
    this.updateBranchList();
  }

  updateBranchList() {
    const branches = this.owlData.childrenMap.get(this.uiState.rootB) || [];
    const container = d3.select('#branchBox').html("");
    this.uiState.activeBranches.clear();
    branches.forEach(iri => {
      const row = container.append('div').attr('class', 'item-row');
      row.append('input').attr('type', 'checkbox').property('checked', true).on('change', e => {
        if (e.target.checked) this.uiState.activeBranches.add(iri); else this.uiState.activeBranches.delete(iri);
      });
      row.append('span').text(this.owlData.nodes.get(iri).label);
      this.uiState.activeBranches.add(iri);
    });
  }

  buildHierarchy(iri, depth) {
    if (depth > this.uiState.maxDepth) return null;
    const children = this.owlData.childrenMap.get(iri) || [];
    return { 
      name: this.owlData.nodes.get(iri).label, 
      depthLevel: depth,
      children: children.map(c => this.buildHierarchy(c, depth + 1)).filter(Boolean) 
    };
  }

  render() {
    if (!this.owlData) return;
    this.gMain.selectAll('*').remove();
    
    const data = { 
      name: this.owlData.nodes.get(this.uiState.startA).label, 
      depthLevel: 0,
      children: [{ 
        name: this.owlData.nodes.get(this.uiState.rootB).label, 
        depthLevel: 1,
        children: Array.from(this.uiState.activeBranches).map(iri => this.buildHierarchy(iri, 2)) 
      }] 
    };

    const root = d3.hierarchy(data);
    
    // Configura√ß√µes de Layout
    let layout;
    const spc = this.uiState.spacing;
    if (this.uiState.layout === 'a4') {
      layout = d3.tree().nodeSize([130 * spc, 180 * spc]);
    } else if (this.uiState.layout === 'radial') {
      layout = d3.cluster().size([2 * Math.PI, 320 * spc]);
    } else if (this.uiState.layout === 'horizontal') {
      layout = d3.tree().nodeSize([120 * spc, 220 * spc]);
    } else {
      layout = d3.tree().nodeSize([200 * spc, 130 * spc]);
    }
    
    layout(root);

    // Mapeamento de Coordenadas
    root.descendants().forEach(d => {
      if(this.uiState.layout === 'horizontal') [d.xP, d.yP] = [d.y, d.x];
      else if(this.uiState.layout === 'radial') {
        d.xP = Math.cos(d.x - Math.PI/2) * d.y;
        d.yP = Math.sin(d.x - Math.PI/2) * d.y;
      } else if(this.uiState.layout === 'a4') {
        d.xP = d.x; d.yP = d.y * 1.2;
      } else [d.xP, d.yP] = [d.x, d.y];
    });

    // Links
    this.gMain.selectAll('.link').data(root.links()).enter().append('path').attr('class', 'link')
      .attr('d', d3.linkVertical().x(d => d.xP).y(d => d.yP));

    // Nodes
    const nodes = this.gMain.selectAll('.node').data(root.descendants()).enter().append('g').attr('class', 'node')
      .attr('transform', d => `translate(${d.xP},${d.yP})`);

    nodes.append('rect').attr('x', -70).attr('y', -18).attr('width', 140).attr('height', 36).attr('rx', 8)
      .attr('fill', d => this.dimColors[Math.min(d.data.depthLevel, 5)].bg)
      .attr('stroke', d => this.dimColors[Math.min(d.data.depthLevel, 5)].stroke);

    nodes.append('text').attr('text-anchor', 'middle').attr('dy', 5)
      .attr('fill', d => this.dimColors[Math.min(d.data.depthLevel, 5)].text)
      .text(d => d.data.name);
    
    this.autofit();
  }

  autofit() {
    const b = this.gMain.node().getBBox();
    const s = Math.min(1.5, 0.85 / Math.max(b.width/window.innerWidth, b.height/window.innerHeight));
    this.svg.transition().duration(800).call(this.zoom.transform, 
      d3.zoomIdentity.translate(window.innerWidth/2 - (b.x + b.width/2)*s, window.innerHeight/2 - (b.y + b.height/2)*s).scale(s)
    );
  }

  exportHighResPng() {
    const bbox = this.gMain.node().getBBox();
    const padding = 80;
    
    // Propor√ß√£o A4
    const contentWidth = bbox.width + padding * 2;
    const contentHeight = bbox.height + padding * 2;
    let finalWidth = contentWidth;
    let finalHeight = contentWidth * 1.414;
    if (contentHeight > finalHeight) {
      finalHeight = contentHeight;
      finalWidth = contentHeight / 1.414;
    }

    const canvas = document.createElement('canvas');
    const scale = 2.5; // Qualidade 
    canvas.width = finalWidth * scale;
    canvas.height = finalHeight * scale;
    const ctx = canvas.getContext('2d');
    
    // Injetar Estilos para o SVG Clone (Garante tipologia e cores no PNG)
    const clone = document.getElementById('svg').cloneNode(true);
    const nodeStyles = Array.from(document.querySelectorAll('.node')).map((n, i) => {
      const rect = n.querySelector('rect');
      const text = n.querySelector('text');
      return `.node:nth-child(${i+1}) rect { fill: ${rect.getAttribute('fill')}; stroke: ${rect.getAttribute('stroke')}; stroke-width: 2.5px; }
              .node:nth-child(${i+1}) text { fill: ${text.getAttribute('fill')}; font-family: sans-serif; font-weight: bold; font-size: 11px; }`;
    }).join(' ');

    const styleNode = document.createElementNS("http://www.w3.org/2000/svg", "style");
    styleNode.textContent = `${nodeStyles} .link { fill: none; stroke: #cbd5e1; stroke-width: 1.5px; }`;
    clone.insertBefore(styleNode, clone.firstChild);

    clone.setAttribute("width", finalWidth);
    clone.setAttribute("height", finalHeight);
    clone.setAttribute("viewBox", `${bbox.x - padding - (finalWidth-contentWidth)/2} ${bbox.y - padding} ${finalWidth} ${finalHeight}`);

    const svgData = new XMLSerializer().serializeToString(clone);
    const img = new Image();
    img.onload = () => {
      ctx.fillStyle = document.body.dataset.theme === 'dark' ? "#020617" : "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const a = document.createElement('a');
      a.download = `taxonomia_A4_${Date.now()}.png`;
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
  }

  bindEvents() {
    document.getElementById('fileInput').onchange = e => this.loadOwl(e.target.files[0]);
    document.getElementById('btnGenerate').onclick = () => this.render();
    document.getElementById('rootSelect').onchange = e => { this.uiState.rootB = e.target.value; this.updateBranchList(); };
    document.getElementById('startSelect').onchange = e => this.uiState.startA = e.target.value;
    document.getElementById('layoutSelect').onchange = e => { this.uiState.layout = e.target.value; this.render(); };
    document.getElementById('btnExportPng').onclick = () => this.exportHighResPng();
    
    document.getElementById('spacingRange').oninput = e => {
      this.uiState.spacing = e.target.value;
      document.getElementById('spacingLabel').textContent = e.target.value;
    };
    document.getElementById('depthRange').oninput = e => {
      this.uiState.maxDepth = e.target.value;
      document.getElementById('depthLabel').textContent = e.target.value;
    };
    
    document.getElementById('themeSelect').onchange = e => document.body.dataset.theme = e.target.value;
    
    document.getElementById('searchInput').oninput = e => {
      const q = e.target.value.toLowerCase();
      this.gMain.selectAll('.node').classed('highlight', d => q && d.data.name.toLowerCase().includes(q));
    };
  }
}

// Inicializar
new OwlViz();
</script>
</body>
</html>
