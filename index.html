<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V3.4 ‚Äî Sistema de Visualiza√ß√£o Cient√≠fica</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #fcfcfd; --text: #101828; --muted: #475467;
      --line: #eaecf0; --accent: #0052cc; --highlight: #f97316;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); 
      font-family: "Inter", "Segoe UI", system-ui, sans-serif; overflow: hidden; }

    header {
      height: 65px; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
    }

    .brand h1 { margin: 0; font-size: 16px; font-weight: 800; color: var(--text); }
    .status-badge { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .status-wait { background: #fef0c7; color: #93370d; }
    .status-ok { background: #ecfdf3; color: #027a48; }

    .controls { display: flex; gap: 10px; }
    .btn {
      border: 1px solid var(--line); background: #fff; color: var(--text); 
      border-radius: 6px; padding: 8px 14px; font-size: 12px; 
      cursor: pointer; transition: 0.2s; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn.primary { background: #101828; color: #fff; border-color: #101828; }

    #wrap { height: calc(100% - 65px); display: grid; grid-template-columns: 1fr 400px; }
    .canvas { position: relative; overflow: hidden; background: #ffffff; }
    svg { width: 100%; height: 100%; cursor: grab; }

    .side {
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto;
    }

    .help-card { background: #f0f7ff; border: 1px solid #cce5ff; padding: 12px; border-radius: 8px; font-size: 11px; color: #004085; line-height: 1.4; }
    .help-card b { display: block; margin-bottom: 4px; color: #0052cc; text-transform: uppercase; letter-spacing: 0.5px; }

    .dimList { border: 1px solid var(--line); border-radius: 8px; background: #fff; overflow: hidden; }
    .dimItems { max-height: 200px; overflow-y: auto; padding: 6px; }
    .dimItem { display: flex; align-items: center; gap: 10px; padding: 6px; font-size: 12px; cursor: pointer; border-radius: 4px; }

    .node rect { stroke-width: 1.5px; rx: 5; ry: 5; transition: 0.2s; }
    .node text { font-size: 11px; font-weight: 700; pointer-events: none; }
    .link { fill: none; stroke: #98a2b3; stroke-width: 1.5px; opacity: 0.6; }
    
    .node--is-root rect { stroke: var(--highlight) !important; stroke-width: 3.5px !important; }
    .node--connector rect { stroke-dasharray: 4,4; fill: #f9fafb !important; stroke: #d0d5dd !important; }

    /* Tooltip Acad√™mico Expandido */
    .tooltip {
      position: fixed; display: none; z-index: 1000; background: #101828; color: #fff; 
      padding: 15px; border-radius: 8px; font-size: 12px; max-width: 350px; line-height: 1.5;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .tooltip .t-header { border-bottom: 1px solid #344054; padding-bottom: 8px; margin-bottom: 10px; }
    .tooltip .t-name { color: #84adff; font-weight: 800; font-size: 14px; display: block; }
    .tooltip .t-dim { color: #98a2b3; font-size: 10px; text-transform: uppercase; font-weight: 700; }
    .tooltip .t-section { margin-top: 10px; }
    .tooltip .t-label { color: #f97316; font-weight: 800; font-size: 10px; text-transform: uppercase; display: block; margin-bottom: 2px; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V3.4</h1>
    <span id="loadStatus" class="status-badge status-wait">INICIANDO...</span>
  </div>
  <div class="controls">
    <button class="btn" onclick="location.reload()">üîÑ Limpar Tudo</button>
    <button class="btn primary" id="btnExport">üì∏ Exportar Figura (300 DPI)</button>
  </div>
</header>

<div id="wrap">
  <div class="canvas"><svg id="svg"></svg></div>
  <div class="side">
    <div class="help-card">
        <b>üí° Guia de Uso</b>
        Este sistema gera taxonomias cient√≠ficas a partir da Ontohate_V2.xlsx.
        1. <b>Filtre</b> as Dimens√µes que deseja analisar.<br>
        2. <b>Selecione</b> um Termo Raiz (ele ser√° o topo e destaque da √°rvore).<br>
        3. <b>Mouse:</b> Passe sobre as classes para ver defini√ß√µes completas.<br>
        4. <b>Navega√ß√£o:</b> Use o scroll para zoom e arraste para mover.
    </div>

    <section>
        <h3 style="font-size:12px; font-weight:800; margin:10px 0;">1. DIMENS√ïES</h3>
        <div class="dimList"><div class="dimItems" id="dimItems">Carregue o arquivo...</div></div>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button class="btn" onclick="toggleDims(true)" style="padding:4px 8px; font-size:10px;">Todas</button>
            <button class="btn" onclick="toggleDims(false)" style="padding:4px 8px; font-size:10px;">Nenhuma</button>
        </div>
    </section>

    <section>
        <h3 style="font-size:12px; font-weight:800; margin:10px 0;">2. TERMO RAIZ</h3>
        <select id="rootSelect" class="btn" style="width:100%; margin-bottom:12px;"></select>
        <button class="btn primary" id="btnGenerate" style="width:100%; justify-content:center;">GERAR VISUALIZA√á√ÉO</button>
    </section>

    <div style="font-size: 10px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 10px;">
        <b>Cores & Formas:</b><br>
        ‚Ä¢ <span style="color:var(--highlight)">Borda Laranja</span>: Termo Raiz Escolhido.<br>
        ‚Ä¢ <span style="color:#0052cc">Coloridos</span>: Classes das Dimens√µes eleitas.<br>
        ‚Ä¢ <span>Tracejado Cinza</span>: Conectores estruturais autom√°ticos.
    </div>
  </div>
</div>

<input type="file" id="manualInput" style="display:none" accept=".xlsx">
<div class="tooltip" id="tooltip"></div>

<script>
let RAW = null;
const svg = d3.select("#svg"), gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.02, 3]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

const status = document.getElementById('loadStatus');
const manual = document.getElementById('manualInput');

async function load() {
    try {
        const res = await fetch('Ontohate_V2.xlsx');
        if (!res.ok) throw new Error();
        const buf = await res.arrayBuffer();
        parse(buf);
    } catch (e) {
        status.textContent = "‚ö†Ô∏è CLIQUE AQUI PARA CARREGAR EXCEL MANUALMENTE";
        status.onclick = () => manual.click();
    }
}

manual.onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => parse(ev.target.result);
    reader.readAsArrayBuffer(e.target.files[0]);
};

function parse(buf) {
    const wb = XLSX.read(buf);
    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const nodes = new Map(), childrenMap = new Map(), dims = new Set();

    data.forEach(row => {
        const name = String(row.Classe || row.Class || "").trim();
        const parent = String(row.Superclasse || row.Superclass || "").trim();
        const dim = String(row.Dimens√£o || row.Subontologia || "Geral").trim();

        if(!name) return;
        nodes.set(name, { 
            name, 
            dim, 
            comment: row.Comment || row.Comments || row.Observa√ß√£o || "Sem descri√ß√£o dispon√≠vel.",
            obs: row.Observa√ß√µes || row.Notas || row.Observacao || ""
        });
        dims.add(dim);
        if(parent) {
            if(!childrenMap.has(parent)) childrenMap.set(parent, []);
            childrenMap.get(parent).push(name);
        }
    });

    RAW = { nodes, childrenMap, dims: Array.from(dims).sort() };
    status.textContent = "ARQUIVO INTEGRADO";
    status.className = "status-badge status-ok";
    status.onclick = null;
    fillUI();
}

function fillUI() {
    document.getElementById('dimItems').innerHTML = RAW.dims.map(d => `
        <label class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:10px; height:10px; border-radius:50%; background:${getCol(d)}"></span>
            ${d}
        </label>
    `).join('');
    document.getElementById('rootSelect').innerHTML = Array.from(RAW.nodes.keys()).sort().map(k => `<option value="${k}">${k}</option>`).join('');
}

function getCol(s) {
    let h = 0; for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
    return `hsl(${Math.abs(h)%360}, 65%, 45%)`;
}

function toggleDims(s) { document.querySelectorAll('.dim-check').forEach(i => i.checked = s); }

function build(node, targets, rootId, visited = new Set()) {
    if (visited.has(node)) return null; visited.add(node);
    const data = RAW.nodes.get(node) || { name: node, dim: "Conector" };
    const kids = (RAW.childrenMap.get(node) || []).map(c => build(c, targets, rootId, visited)).filter(c => c !== null);
    const isTarget = targets.has(data.dim) || node === rootId;
    if (isTarget || kids.length > 0) return { ...data, isRoot: node === rootId, isCon: !isTarget, children: kids.length > 0 ? kids : null };
    return null;
}

document.getElementById('btnGenerate').onclick = () => {
    const rootId = document.getElementById('rootSelect').value;
    const targets = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    const treeData = build(rootId, targets, rootId);
    
    if(!treeData) return alert("Nenhum termo encontrado para este filtro.");

    gMain.selectAll("*").remove();
    const root = d3.hierarchy(treeData);
    d3.tree().nodeSize([250, 160])(root);

    gMain.selectAll(".link").data(root.links()).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    const node = gMain.selectAll(".node").data(root.descendants()).enter().append("g")
        .attr("class", d => `node ${d.data.isCon ? 'node--connector' : ''} ${d.data.isRoot ? 'node--is-root' : ''}`)
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseover", showTooltip).on("mouseout", () => d3.select("#tooltip").style("display", "none"));

    node.each(function(d) {
        const g = d3.select(this);
        const txt = g.append("text").attr("text-anchor", "middle").attr("y", 5).text(d.data.name);
        const w = Math.max(160, txt.node().getBBox().width + 30), h = 42;
        const col = d.data.isCon ? "#fff" : getCol(d.data.dim);
        const textColor = d.data.isCon ? "#101828" : "#fff";
        
        g.insert("rect", "text").attr("width", w).attr("height", h).attr("x", -w/2).attr("y", -h/2).attr("fill", col).attr("stroke", "#333");
        txt.style("fill", textColor);
    });
    
    fit();
};

function fit() {
    const b = gMain.node().getBBox();
    const sw = svg.node().clientWidth, sh = svg.node().clientHeight;
    const sc = Math.min(0.9, 0.9 / Math.max(b.width/sw, b.height/sh));
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(sw/2 - (b.x + b.width/2)*sc, 60).scale(sc));
}

// 2. Tooltip com TODAS as informa√ß√µes (Comment + Obs)
function showTooltip(e, d) {
    const t = d3.select("#tooltip");
    t.style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
     .html(`
        <div class="t-header">
            <span class="t-dim">${d.data.dim}</span>
            <span class="t-name">${d.data.name}</span>
        </div>
        <div class="t-section">
            <span class="t-label">Coment√°rio / Defini√ß√£o</span>
            ${d.data.comment}
        </div>
        ${d.data.obs ? `
        <div class="t-section">
            <span class="t-label">Observa√ß√µes Cient√≠ficas</span>
            ${d.data.obs}
        </div>` : ''}
     `);
}

document.getElementById('btnExport').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svgEl);
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
    img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = 3;
        canvas.width = svgEl.clientWidth * scale; canvas.height = svgEl.clientHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.scale(scale, scale); ctx.drawImage(img, 0, 0);
        const link = document.createElement("a");
        link.download = `ontoHate_simulacao_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
    };
};

load();
</script>
</body>
</html>
