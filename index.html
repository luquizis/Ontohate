<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V2.5 ‚Äî Gerador de Taxonomia</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --panel:#f8f9fa; --text:#101828; --muted:#667085;
      --line:#d0d5dd; --accent: #f97316;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); 
      font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden;}

    header{
      height: 65px; z-index: 100; background: #fff; border-bottom: 1px solid var(--line);
      padding: 0 20px; display:flex; align-items:center; justify-content: space-between;
    }

    .brand h1{margin:0; font-size:15px; font-weight:800; color: var(--text);}
    .brand span{font-size:11px; color:var(--muted);}

    .controls{display:flex; gap:10px; align-items:center;}
    
    .btn,.file,.input,.select{
      border:1px solid var(--line); background: #fff;
      color: var(--text); border-radius: 8px; padding: 8px 14px;
      font-size: 12px; display:inline-flex; gap:8px; align-items:center;
      cursor:pointer; transition: all 0.2s ease;
    }
    .btn:hover{background: #f2f4f7;}
    .btn.primary{background: var(--text); color: #fff; border-color: var(--text); font-weight: 600;}
    
    .file input[type="file"]{display:none;}
    .input input{border:none; outline:none; background:transparent; width: 160px;}

    #wrap{ height: calc(100% - 65px); display:grid; grid-template-columns: 1fr 340px; }

    .canvas{position: relative; overflow: hidden; background: #ffffff;}
    svg{width:100%; height:100%; cursor: grab;}

    .side{
      background: var(--panel); border-left: 1px solid var(--line);
      padding: 24px; display:flex; flex-direction:column; gap:20px; overflow-y: auto;
    }

    .dimList{ border:1px solid var(--line); border-radius: 8px; background:#fff; overflow:hidden; }
    .dimItems{max-height: 250px; overflow-y:auto; padding: 8px; display: flex; flex-direction: column; gap: 4px;}
    .dimItem{ display:flex; align-items:center; gap:10px; padding: 6px; font-size:12px; cursor: pointer; border-radius: 4px;}
    .dimItem:hover{background: #f9fafb;}

    .tooltip{
      position: fixed; display: none; z-index: 1000;
      background: rgba(16,24,40,0.98); color: #fff;
      padding: 10px; border-radius: 6px; font-size: 11px;
      max-width: 260px; pointer-events: none; line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .tooltip b { display: block; color: var(--accent); margin-bottom: 2px; }
    .tooltip p { margin: 5px 0 0 0; padding-top: 5px; border-top: 1px solid #444; }

    .empty-msg { text-align: center; margin-top: 40%; color: var(--muted); font-size: 14px; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <h1>ONTOHATE V2.5</h1>
    <span>Carregue o Excel para ativar as op√ß√µes</span>
  </div>

  <div class="controls">
    <label class="file btn primary">üìÇ Selecionar Arquivo Excel <input id="fileInput" type="file" accept=".xlsx,.xls" /></label>
    <div class="input">üîé <input id="search" placeholder="Buscar classe..." /></div>
    <div class="btn" id="btnPng">üì∏ Exportar PNG</div>
  </div>
</header>

<div id="wrap">
  <div class="canvas"><svg id="svg"></svg></div>
  
  <div class="side" id="sidePanel">
    <div id="setupMsg" class="empty-msg">Aguardando arquivo...</div>
    
    <div id="optionsArea" style="display: none;">
        <section>
            <h3 style="font-size:13px; margin:0 0 10px 0;">1. Dimens√µes</h3>
            <div class="dimList"><div class="dimItems" id="dimItems"></div></div>
        </section>

        <section style="margin-top: 20px;">
            <h3 style="font-size:13px; margin:0 0 10px 0;">2. Raiz da √Årvore</h3>
            <select id="rootSelect" class="select" style="width:100%; margin-bottom:15px;"></select>
            <div class="btn primary" id="btnGenerate" style="width:100%; justify-content:center;">Gerar Taxonomia</div>
        </section>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
let RAW_DATA = null;
const svg = d3.select("#svg");
const gMain = svg.append("g");
const zoom = d3.zoom().scaleExtent([0.05, 3]).on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

function canonizeDim(dim) {
    let d = String(dim || "Geral").trim();
    if (d.toLowerCase().includes("motivacao e consequencia")) return "Motiva√ß√£o e consequ√™ncia";
    return d;
}

function getContrast(hex){
    const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
    return ((r*299)+(g*587)+(b*114))/1000 > 150 ? '#000000' : '#ffffff';
}

function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash) % 360}, 65%, 40%)`;
}

// GATILHO DE CARREGAMENTO
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if(!file) return;

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        const nodes = new Map(), childrenMap = new Map(), dims = new Set();

        json.forEach(row => {
            const name = String(row.Classe || row.Class || "").trim();
            const parent = String(row.Superclasse || row.Superclass || "").trim();
            const dim = canonizeDim(row.Dimens√£o || row.Subontologia || "Geral");

            if(!name) return;
            nodes.set(name, { name, dim, comment: row.Comment || row.Observa√ß√£o || row.Observacoes || "" });
            dims.add(dim);

            if(parent) {
                if(!childrenMap.has(parent)) childrenMap.set(parent, []);
                childrenMap.get(parent).push(name);
            }
        });

        RAW_DATA = { nodes, childrenMap, dims: Array.from(dims).sort() };
        
        // MOSTRAR PAINEL
        document.getElementById('setupMsg').style.display = 'none';
        document.getElementById('optionsArea').style.display = 'block';
        
        renderDimList();
        updateValidRoots();
        alert("Planilha carregada com sucesso! Agora escolha a Raiz ao lado.");

    } catch (err) {
        console.error(err);
        alert("Erro ao ler o arquivo. Verifique se √© um Excel v√°lido.");
    }
});

function renderDimList() {
    const container = document.getElementById('dimItems');
    container.innerHTML = RAW_DATA.dims.map(d => `
        <label class="dimItem">
            <input type="checkbox" checked value="${d}" class="dim-check">
            <span style="width:10px; height:10px; border-radius:50%; background:${stringToColor(d)}"></span>
            ${d}
        </label>
    `).join('');
    container.querySelectorAll('input').forEach(i => i.onchange = updateValidRoots);
}

function updateValidRoots() {
    const select = document.getElementById('rootSelect');
    select.innerHTML = '<option value="">Selecione...</option>';
    RAW_DATA.nodes.forEach((v, k) => {
        if((RAW_DATA.childrenMap.get(k) || []).length > 0) {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = k;
            select.appendChild(opt);
        }
    });
}

function buildHierarchy(nodeName, selectedDims, visited = new Set()) {
    if (visited.has(nodeName)) return null;
    visited.add(nodeName);
    const nodeData = RAW_DATA.nodes.get(nodeName) || { name: nodeName, dim: "Geral" };
    const children = (RAW_DATA.childrenMap.get(nodeName) || [])
        .map(c => buildHierarchy(c, selectedDims, visited))
        .filter(c => c !== null);

    const isTarget = selectedDims.has(nodeData.dim);
    if (isTarget || children.length > 0) {
        return { ...nodeData, isConnector: !isTarget, children: children.length > 0 ? children : null };
    }
    return null;
}

function render() {
    const rootName = document.getElementById('rootSelect').value;
    const selectedDims = new Set([...document.querySelectorAll('.dim-check:checked')].map(i => i.value));
    if(!rootName) return alert("Selecione uma classe raiz!");

    const treeData = buildHierarchy(rootName, selectedDims);
    if(!treeData) return alert("Nenhum dado encontrado para estas dimens√µes.");

    gMain.selectAll("*").remove();
    const root = d3.hierarchy(treeData);
    const treeLayout = d3.tree().nodeSize([200, 120]); 
    treeLayout(root);

    const links = root.links();
    const nodes = root.descendants();

    gMain.selectAll(".link").data(links).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    const node = gMain.selectAll(".node").data(nodes).enter().append("g")
        .attr("class", d => `node ${d.data.isConnector ? 'node--connector' : ''}`)
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseover", (e, d) => {
            d3.select("#tooltip").style("display", "block").style("left", (e.pageX+15)+"px").style("top", (e.pageY+15)+"px")
              .html(`<b>${d.data.name}</b><i>${d.data.dim}</i><p>${d.data.comment || 'Sem observa√ß√µes.'}</p>`);
        })
        .on("mouseout", () => d3.select("#tooltip").style("display", "none"));

    node.each(function(d) {
        const g = d3.select(this);
        const textElement = g.append("text").attr("text-anchor", "middle").attr("y", 4).style("font-size", "11px").style("font-weight", "600").text(d.data.name);
        const bbox = textElement.node().getBBox();
        const rectW = Math.max(140, bbox.width + 24), rectH = 38;
        const bgColor = d.data.isConnector ? "#ffffff" : stringToColor(d.data.dim);
        
        g.insert("rect", "text").attr("width", rectW).attr("height", rectH).attr("x", -rectW/2).attr("y", -rectH/2)
            .attr("fill", bgColor).attr("stroke", d.data.isConnector ? "#98a2b3" : d3.color(bgColor).darker());

        textElement.style("fill", getContrast(d3.rgb(bgColor).formatHex()));
    });

    const bounds = gMain.node().getBBox();
    const scale = 0.8 / Math.max(bounds.width / svg.node().clientWidth, bounds.height / svg.node().clientHeight);
    svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(svg.node().clientWidth/2, 60).scale(scale));
}

document.getElementById('btnGenerate').onclick = render;
document.getElementById('btnPng').onclick = function() {
    const svgEl = document.getElementById('svg');
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svgEl);
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
    img.onload = function() {
        const canvas = document.createElement("canvas");
        canvas.width = svgEl.clientWidth * 2; canvas.height = svgEl.clientHeight * 2;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.scale(2,2); ctx.drawImage(img, 0, 0);
        const link = document.createElement("a");
        link.download = "taxonomia.png"; link.href = canvas.toDataURL("image/png"); link.click();
    };
};
</script>
</body>
</html>
