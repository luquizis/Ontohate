<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONTOHATE V2 ‚Äî Sistema de Taxonomia Profissional</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #ffffff; --panel: #f6f7f9; --text: #101828; --line: #e4e7ec;
      --accent: #22c55e; --radius: 12px; --shadow: 0 8px 24px rgba(16,24,40,0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --panel: #111111; --text: #ececec; --line: #333333;
    }
    
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Arial, Helvetica, sans-serif; overflow: hidden; }
    
    header {
      background: var(--panel); border-bottom: 1px solid var(--line);
      padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
      height: 70px; box-sizing: border-box; z-index: 100;
    }

    .controls { display: flex; gap: 12px; align-items: center; }
    .btn {
      background: var(--bg); border: 1px solid var(--line); color: var(--text);
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold;
      transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }
    .btn.primary { background: var(--accent); color: #fff; border: none; }

    #wrap { display: flex; height: calc(100% - 70px); }
    .sidebar { width: 380px; background: var(--panel); border-right: 1px solid var(--line); overflow-y: auto; padding: 24px; box-sizing: border-box; }
    .canvas-area { flex: 1; position: relative; background: var(--bg); overflow: hidden; }
    
    svg { width: 100%; height: 100%; background: transparent; }
    .link { fill: none; stroke: #94a3b8; stroke-width: 1.5px; opacity: 0.4; stroke-linecap: round; }
    .node rect { stroke-width: 1.5px; rx: 10; ry: 10; }
    .node text { font-family: Arial, sans-serif; font-weight: bold; pointer-events: none; }

    .tooltip {
      position: fixed; background: rgba(255,255,255,0.98); border: 1px solid var(--line); padding: 12px;
      border-radius: 10px; color: #101828; pointer-events: none; font-size: 13px;
      box-shadow: var(--shadow); z-index: 1000; display: none; max-width: 350px; line-height: 1.4;
    }
    [data-theme="dark"] .tooltip { background: rgba(20,20,20,0.98); color: #fff; border-color: #444; }

    .dim-group { margin-bottom: 20px; }
    .dim-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 13px; cursor: pointer; font-weight: 600; }
    .dim-item input { width: 16px; height: 16px; accent-color: var(--accent); }

    hr { border: 0; border-top: 1px solid var(--line); margin: 20px 0; }
    h3 { font-size: 14px; margin-top: 0; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }

    .status-bar { font-size: 11px; color: var(--text); opacity: 0.7; margin-top: 5px; }
  </style>
</head>
<body data-theme="light">

<header>
  <div class="controls">
    <label class="btn primary">
      <span>üìÅ Anexar Base (XLSX)</span>
      <input type="file" id="fileInput" accept=".xlsx" style="display:none">
    </label>
    <button class="btn" id="btnSyncGit">üîÑ Sincronizar GitHub</button>
    <select id="themeSelect" class="btn">
      <option value="light">‚òÄÔ∏è Fundo Branco</option>
      <option value="dark">üåô Fundo Preto</option>
    </select>
  </div>
  <div class="controls">
    <button class="btn" id="btnExportPng">üñºÔ∏è Salvar PNG</button>
    <button class="btn" id="btnExportSvg">üìê Salvar SVG</button>
  </div>
</header>

<div id="wrap">
  <div class="sidebar">
    <h3>1. Cruzar Dimens√µes</h3>
    <div id="dimList" class="dim-group"></div>
    <hr>
    <h3>2. Definir Raiz</h3>
    <select id="rootSelect" style="width:100%; padding:10px; border-radius:8px; background: var(--bg); color: var(--text); border: 1px solid var(--line); font-family: Arial, sans-serif;"></select>
    <div class="status-bar" id="loadStatus">Aguardando base de dados...</div>
    <br>
    <button class="btn primary" id="btnGenerate" style="width:100%; justify-content:center; padding: 12px;">GERAR TAXONOMIA</button>
  </div>
  
  <div class="canvas-area">
    <svg id="svg"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
</div>

<script>
// --- CONFIGURA√á√ÉO ---
const GITHUB_XLSX_URL = "https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/HateSpeechTaxonomy.xlsx";

let RAW = null;
const svg = d3.select("#svg");
const gMain = svg.append("g").attr("id", "main-group");
const zoom = d3.zoom().on("zoom", (e) => gMain.attr("transform", e.transform));
svg.call(zoom);

// Padroniza√ß√£o: Remove (v2) e limpa espa√ßos
function canonName(name) {
    return String(name || "").replace(/\s*\(v2\)/gi, "").trim();
}

// C√°lculo de contraste para texto sobre cores
function getContrastColor(hex) {
    if (hex === "#cccccc" || hex === "#dddddd") return "#101828";
    const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
    const yiq = (r * 299 + g * 587 + b * 114) / 1000;
    return yiq >= 128 ? "#000000" : "#ffffff";
}

// Gerador de cores por dimens√£o
function getDimColor(dim) {
    const colors = ["#2563eb", "#9333ea", "#d97706", "#059669", "#dc2626", "#0891b2", "#4f46e5"];
    let hash = 0;
    for (let i = 0; i < dim.length; i++) hash = dim.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
}

// Processamento Integral Multi-Abas
async function processFile(buf, fileName) {
    const wb = XLSX.read(buf, {type: 'array'});
    const nodes = new Map(), dimensions = new Set(), childrenMap = new Map();

    wb.SheetNames.forEach(sheetName => {
        const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
        json.forEach(row => {
            const c = String(row.Classe || row.class || "").trim();
            const p = String(row.Superclasse || row.superclass || "").trim();
            const d = canonName(row.Dimens√£o || row.Subontologia || row.subontologia || "Geral");

            if(c) {
                if(!nodes.has(c)) {
                    nodes.set(c, { 
                        name: c, 
                        dim: d, 
                        comment: row.Comment || row.comment || row['rdfs:comment'] || "", 
                        obs: row.Observa√ß√£o || row.notes || row.Observacoes || "" 
                    });
                }
                dimensions.add(d);
                if(p && p !== c) {
                    if(!childrenMap.has(p)) childrenMap.set(p, []);
                    if(!childrenMap.get(p).includes(c)) childrenMap.get(p).push(c);
                }
            }
        });
    });

    RAW = { nodes, dimensions: Array.from(dimensions).sort(), childrenMap };
    updateUI(fileName);
}

function updateUI(fileName) {
    const dList = d3.select("#dimList").html("");
    RAW.dimensions.forEach(d => {
        const label = dList.append("label").attr("class", "dim-item");
        label.append("input").attr("type", "checkbox").attr("checked", true).attr("value", d);
        label.append("span").text(d).style("color", getDimColor(d));
    });

    const rSelect = d3.select("#rootSelect").html("");
    Array.from(RAW.nodes.keys()).sort().forEach(n => rSelect.append("option").text(n).attr("value", n));
    
    document.getElementById("loadStatus").innerText = `Base: ${fileName} | ${RAW.nodes.size} classes`;
}

// Renderiza√ß√£o D3 (Top-Down Anti-Sobreposi√ß√£o)
function render() {
    if(!RAW) return;
    gMain.selectAll("*").remove();
    
    const rootName = d3.select("#rootSelect").property("value");
    const selectedDims = new Set();
    d3.selectAll("#dimList input:checked").each(function() { selectedDims.add(this.value); });

    function buildHierarchy(name, visited = new Set()) {
        if (visited.has(name)) return null;
        visited.add(name);
        const node = RAW.nodes.get(name) || { name: name, dim: "N/A" };
        const children = (RAW.childrenMap.get(name) || [])
            .map(c => buildHierarchy(c, new Set(visited)))
            .filter(Boolean);
        return { ...node, children };
    }

    const rootData = buildHierarchy(rootName);
    if(!rootData) return;

    const hierarchy = d3.hierarchy(rootData);
    // Espa√ßamento generoso para evitar sobreposi√ß√£o (NodeSize: largura, altura)
    const tree = d3.tree().nodeSize([280, 150]); 
    tree(hierarchy);

    // Conectores em curva
    gMain.selectAll(".link").data(hierarchy.links()).enter().append("path").attr("class", "link")
        .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

    // N√≥s
    const node = gMain.selectAll(".node").data(hierarchy.descendants()).enter().append("g")
        .attr("class", "node").attr("transform", d => `translate(${d.x},${d.y})`)
        .on("mouseenter", (e, d) => {
            const tooltip = d3.select("#tooltip");
            tooltip.style("display", "block").html(`
                <div style="font-weight:900; border-bottom:1px solid #ddd; margin-bottom:5px; padding-bottom:5px;">${d.data.name}</div>
                <div style="font-size:11px; color:#666;">DIMENS√ÉO: ${d.data.dim}</div>
                <div style="margin-top:8px;"><b>Comments:</b> ${d.data.comment || '(vazio)'}</div>
                <div style="margin-top:4px;"><b>Obs:</b> ${d.data.obs || '(vazio)'}</div>
            `);
        })
        .on("mousemove", (e) => d3.select("#tooltip").style("left", (e.pageX+20)+"px").style("top", (e.pageY+20)+"px"))
        .on("mouseleave", () => d3.select("#tooltip").style("display", "none"));

    // Ret√¢ngulos (Preenchidos com cor ou cinza)
    node.append("rect").attr("x", -110).attr("y", -20).attr("width", 220).attr("height", 40)
        .attr("fill", d => selectedDims.has(d.data.dim) ? getDimColor(d.data.dim) : "#dddddd")
        .attr("stroke", d => d3.lab(selectedDims.has(d.data.dim) ? getDimColor(d.data.dim) : "#cccccc").darker(1));

    // Texto Arial Negrito
    node.append("text").attr("text-anchor", "middle").attr("dy", 6)
        .attr("fill", d => getContrastColor(selectedDims.has(d.data.dim) ? getDimColor(d.data.dim) : "#dddddd"))
        .style("font-size", "12px").style("font-weight", "bold")
        .text(d => d.data.name.length > 26 ? d.data.name.substring(0, 24)+"..." : d.data.name);

    // Ajuste Inicial de Zoom
    const bounds = gMain.node().getBBox();
    const svgNode = svg.node();
    const fullWidth = svgNode.clientWidth, fullHeight = svgNode.clientHeight;
    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(fullWidth/2, 60).scale(0.7));
}

// --- EXPORTA√á√ÉO CORRIGIDA ---
function exportPNG() {
    const svgNode = document.getElementById("svg");
    const serializer = new XMLSerializer();
    let svgString = serializer.serializeToString(svgNode);

    const canvas = document.createElement("canvas");
    const svgSize = gMain.node().getBBox();
    const padding = 100;

    // Multiplicador 3x para alta resolu√ß√£o
    const scale = 3;
    canvas.width = (svgSize.width + padding * 2) * scale;
    canvas.height = (svgSize.height + padding * 2) * scale;
    
    const ctx = canvas.getContext("2d");
    ctx.scale(scale, scale);

    // Fundo conforme Tema
    ctx.fillStyle = document.body.dataset.theme === "dark" ? "#000000" : "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const img = new Image();
    const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);
    
    img.onload = function() {
        ctx.drawImage(img, padding - svgSize.x, padding - svgSize.y);
        const link = document.createElement("a");
        link.download = `taxonomia_ontohate_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
        URL.revokeObjectURL(url);
    };
    img.src = url;
}

// --- EVENTOS ---
d3.select("#btnGenerate").on("click", render);
d3.select("#themeSelect").on("change", function() { document.body.dataset.theme = this.value; });

d3.select("#fileInput").on("change", async (e) => {
    const f = e.target.files[0];
    if(f) processFile(await f.arrayBuffer(), f.name);
});

d3.select("#btnSyncGit").on("click", async () => {
    try {
        const res = await fetch(`${GITHUB_XLSX_URL}?t=${new Date().getTime()}`);
        if(!res.ok) throw new Error();
        processFile(await res.arrayBuffer(), "GitHub (HateSpeechTaxonomy)");
    } catch(e) {
        alert("Erro ao sincronizar com o GitHub. Verifique o link no c√≥digo.");
    }
});

d3.select("#btnExportPng").on("click", exportPNG);
d3.select("#btnExportSvg").on("click", () => {
    const source = new XMLSerializer().serializeToString(document.getElementById("svg"));
    const link = document.createElement("a");
    link.download = "taxonomia.svg";
    link.href = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
    link.click();
});
</script>
</body>
</html>
